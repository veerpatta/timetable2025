<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
	<title>Timetable Command Center - Veer Patta Public School</title>
	<meta name="theme-color" content="#2563eb">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="VPPS Timetable">
	<meta name="mobile-web-app-capable" content="yes">

	<!-- LIBRARIES (CDN) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

	<!-- FONTS -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

	<!-- STYLES -->
	<style>
		/* CSS Variables for Theme */
		:root {
			--primary-50: #eff6ff;
			--primary-100: #dbeafe;
			--primary-200: #bfdbfe;
			--primary-300: #93c5fd;
			--primary-400: #60a5fa;
			--primary-500: #3b82f6;
			--primary-600: #2563eb;
			--primary-700: #1d4ed8;
			--primary-800: #1e40af;
			--primary-900: #1e3a8a;

			--gray-50: #f9fafb;
			--gray-100: #f3f4f6;
			--gray-200: #e5e7eb;
			--gray-300: #d1d5db;
			--gray-400: #9ca3af;
			--gray-500: #6b7280;
			--gray-600: #4b5563;
			--gray-700: #374151;
			--gray-800: #1f2937;
			--gray-900: #111827;

			--green-500: #10b981;
			--yellow-50: #fffbeb;
			--yellow-100: #fef3c7;
			--yellow-500: #f59e0b;
			--red-500: #ef4444;
			--red-600: #dc2626;

			--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
			--shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
			--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
			--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
			--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

			--radius: 0.5rem;
			--radius-lg: 0.75rem;
		}

		/* Global Styles */
		* {
			margin: 0;
/* Highlight current period column - Mobile Enhanced */
.highlight-period {
  background: linear-gradient(135deg, var(--yellow-100), var(--yellow-50)) !important;
  color: var(--primary-800) !important;
  font-weight: 700 !important;
  border-left: 3px solid var(--yellow-500) !important;
  position: relative;
}

.highlight-period::after {
  content: "🔴 LIVE";
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.6rem;
  color: var(--red-600);
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(255,255,255,0.8);
}

@media (max-width: 768px) {
  .highlight-period::after {
    content: "🔴";
    font-size: 0.7rem;
  }
}
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Inter', system-ui, -apple-system, sans-serif;
			background: linear-gradient(135deg, var(--primary-50) 0%, var(--gray-50) 100%);
			color: var(--gray-900);
			min-height: 100vh;
			line-height: 1.6;
		}

		/* Loading Screen */
		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: white;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 9999;
			transition: opacity 0.3s ease;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid var(--gray-200);
			border-top-color: var(--primary-600);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* App Container */
		.app-container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 0.5rem;
		}
		
		/* Mobile-first approach */
		@media (min-width: 768px) {
			.app-container {
				padding: 1rem;
			}
		}

		/* Header - Mobile Optimized */
		header {
			background: white;
			border-radius: var(--radius-lg);
			padding: 1rem;
			margin-bottom: 1rem;
			box-shadow: var(--shadow-md);
			text-align: center;
		}

		header h1 {
			font-size: 1.25rem;
			font-weight: 800;
			color: var(--primary-800);
			margin-bottom: 0.25rem;
			line-height: 1.3;
		}

		header p {
			color: var(--gray-600);
			font-size: 0.8rem;
		}
		
		/* Header responsive */
		@media (min-width: 768px) {
			header {
				padding: 1.5rem;
				margin-bottom: 1.5rem;
			}
			
			header h1 {
				font-size: 1.875rem;
			}
			
			header p {
				font-size: 0.875rem;
			}
		}

		/* Navigation - Mobile Optimized */
		nav {
			background: white;
			border-radius: var(--radius-lg);
			padding: 0.5rem;
			margin-bottom: 1rem;
			box-shadow: var(--shadow);
			display: flex;
			gap: 0.25rem;
			overflow-x: auto;
			scrollbar-width: thin;
			-webkit-overflow-scrolling: touch;
		}

		nav::-webkit-scrollbar {
			height: 4px;
		}

		nav::-webkit-scrollbar-thumb {
			background: var(--gray-300);
			border-radius: 3px;
		}

		.nav-button {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.25rem;
			padding: 0.75rem;
			min-width: 48px; /* Minimum touch target */
			min-height: 48px; /* Minimum touch target */
			background: transparent;
			border: 1px solid var(--gray-200);
			border-radius: var(--radius-lg);
			color: var(--gray-700);
			font-size: 0.75rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
			white-space: nowrap;
			flex-shrink: 0;
			text-align: center;
		}

		.nav-button:active {
			background: var(--primary-100);
			border-color: var(--primary-400);
			transform: scale(0.98);
		}

		.nav-button:hover {
			background: var(--primary-50);
			border-color: var(--primary-300);
			color: var(--primary-700);
		}

		.nav-button.active {
			background: var(--primary-600);
			border-color: var(--primary-600);
			color: white;
			box-shadow: var(--shadow-md);
		}

		.nav-button svg {
			width: 20px;
			height: 20px;
			flex-shrink: 0;
		}
		
		/* Show labels on mobile too for clarity */
		.nav-button span {
			display: inline;
		}
		
		/* Show text on larger screens */
		@media (min-width: 768px) {
			nav {
				padding: 0.75rem;
				margin-bottom: 1.5rem;
				gap: 0.5rem;
			}
			
			.nav-button {
				padding: 0.625rem 1rem;
				font-size: 0.875rem;
				font-weight: 500;
				gap: 0.5rem;
			}
			
			/* Labels already visible on mobile; no change needed here */
			
			.nav-button svg {
				width: 18px;
				height: 18px;
			}
		}

		/* Main Content */
		.main-content {
			animation: fadeIn 0.3s ease;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Cards - Mobile Optimized */
		.card {
			background: white;
			border-radius: var(--radius-lg);
			padding: 1rem;
			box-shadow: var(--shadow);
			margin-bottom: 1rem;
		}
		
		@media (min-width: 768px) {
			.card {
				padding: 1.5rem;
				margin-bottom: 1.5rem;
			}
		}

		/* Stat Cards - Mobile Optimized */
		.stat-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 0.75rem;
			margin-bottom: 1rem;
		}

		.stat-card {
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			gap: 0.75rem;
			padding: 1rem;
			background: white;
			border-radius: var(--radius-lg);
			box-shadow: var(--shadow);
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.stat-card:active {
			transform: scale(0.98);
		}

		.stat-card-icon {
			width: 40px;
			height: 40px;
			border-radius: var(--radius-lg);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			flex-shrink: 0;
		}

		.stat-card-icon svg {
			width: 20px;
			height: 20px;
		}

		.stat-card-label {
			font-size: 0.7rem;
			color: var(--gray-500);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			line-height: 1.2;
		}

		.stat-card-value {
			font-size: 1.25rem;
			font-weight: 700;
			color: var(--gray-900);
			line-height: 1;
		}
		
		/* Larger screens get row layout */
		@media (min-width: 768px) {
			.stat-grid {
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 1rem;
				margin-bottom: 1.5rem;
			}
			
			.stat-card {
				flex-direction: row;
				text-align: left;
				gap: 1rem;
				padding: 1.25rem;
			}
			
			.stat-card:hover {
				transform: translateY(-2px);
				box-shadow: var(--shadow-lg);
			}
			
			.stat-card-icon {
				width: 50px;
				height: 50px;
			}
			
			.stat-card-icon svg {
				width: 24px;
				height: 24px;
			}
			
			.stat-card-label {
				font-size: 0.75rem;
			}
			
			.stat-card-value {
				font-size: 1.5rem;
			}
		}

		/* Tables - Mobile Optimized */
		.table-container {
			overflow-x: auto;
			margin: 0.5rem -0.5rem;
			padding: 0 0.5rem;
			-webkit-overflow-scrolling: touch;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			font-size: 0.8rem;
		}

		th {
			background: var(--gray-50);
			color: var(--gray-700);
			font-weight: 600;
			text-align: center;
			padding: 0.5rem 0.25rem;
			border-bottom: 2px solid var(--gray-200);
			position: sticky;
			top: 0;
			z-index: 10;
			font-size: 0.75rem;
			line-height: 1.2;
		}

		td {
			padding: 0.5rem 0.25rem;
			border-bottom: 1px solid var(--gray-100);
			vertical-align: top;
			text-align: center;
			font-size: 0.75rem;
		}

		tr:active {
			background: var(--primary-50);
		}

		/* Sticky first column support (works if class is on parent or table) */
		.sticky-first-col table thead th:first-child,
		.sticky-first-col table tbody td:first-child,
		.sticky-first-col thead th:first-child,
		.sticky-first-col tbody td:first-child {
			position: sticky;
			left: 0;
			background: white;
			z-index: 2;
			box-shadow: 2px 0 0 0 var(--gray-200);
		}
		
		/* Larger screens get better spacing */
		@media (min-width: 768px) {
			.table-container {
				margin: 1rem -0.5rem;
			}
			
			table {
				font-size: 0.875rem;
			}
			
			th {
				padding: 0.75rem;
				text-align: left;
				font-size: 0.875rem;
			}
			
			td {
				padding: 0.75rem;
				font-size: 0.875rem;
			}
			
			tr:hover {
				background: var(--primary-50);
			}
		}

		.subject {
			font-weight: 600;
			color: var(--gray-900);
			margin-bottom: 0.125rem;
			font-size: 0.7rem;
			line-height: 1.2;
		}

		.teacher {
			font-size: 0.65rem;
			color: var(--gray-600);
			line-height: 1.1;
		}

		.substitute {
			color: var(--primary-600);
			font-weight: 500;
		}

		.line-through {
			text-decoration: line-through;
			opacity: 0.5;
		}

		.class-name {
			font-size: 0.65rem;
			color: var(--gray-500);
			margin-top: 0.125rem;
			line-height: 1.1;
		}
		
		/* Larger screens get better text sizing */
		@media (min-width: 768px) {
			.subject {
				font-size: 0.875rem;
			}
			
			.teacher {
				font-size: 0.75rem;
			}
			
			.class-name {
				font-size: 0.75rem;
			}
		}

		/* Form Elements - Mobile Optimized */
		select {
			width: 100%;
			padding: 0.75rem;
			min-height: 48px; /* Touch-friendly minimum */
			border: 2px solid var(--gray-300);
			border-radius: var(--radius-lg);
			background: white;
			font-size: 1rem; /* Prevent zoom on iOS */
			color: var(--gray-700);
			cursor: pointer;
			transition: all 0.2s;
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
			background-position: right 0.75rem center;
			background-repeat: no-repeat;
			background-size: 1rem;
			padding-right: 2.5rem;
		}

		select:hover {
			border-color: var(--primary-400);
		}

		select:focus {
			outline: none;
			border-color: var(--primary-500);
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}
		
		select:active {
			border-color: var(--primary-600);
		}
		
		/* Larger screens */
		@media (min-width: 768px) {
			select {
				padding: 0.625rem 0.75rem;
				font-size: 0.875rem;
				border-width: 1px;
				min-height: auto;
			}
		}

		/* Buttons - Mobile Optimized */
		.button {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			padding: 0.875rem 1rem;
			min-height: 48px; /* Touch-friendly minimum */
			border-radius: var(--radius-lg);
			font-size: 0.9rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
			border: none;
			width: 100%;
			text-align: center;
			user-select: none;
			-webkit-user-select: none;
			-webkit-tap-highlight-color: transparent;
		}

		.button:active {
			transform: scale(0.98);
		}

		.button svg {
			width: 20px;
			height: 20px;
			flex-shrink: 0;
		}
		
		/* Larger screens */
		@media (min-width: 768px) {
			.button {
				padding: 0.625rem 1.25rem;
				font-size: 0.875rem;
				font-weight: 500;
				min-height: auto;
			}
			
			.button svg {
				width: 18px;
				height: 18px;
			}
		}

		.button-primary {
			background: var(--primary-600);
			color: white;
		}

		.button-primary:hover {
			background: var(--primary-700);
			transform: translateY(-1px);
			box-shadow: var(--shadow-md);
		}

		.button-secondary {
			background: var(--gray-100);
			color: var(--gray-700);
			border: 1px solid var(--gray-300);
		}

		.button-secondary:hover {
			background: var(--gray-200);
			transform: translateY(-1px);
		}

		.button-danger {
			background: var(--red-500);
			color: white;
		}

		.button-danger:hover {
			background: var(--red-600);
			transform: translateY(-1px);
			box-shadow: var(--shadow-md);
		}

		.button-whatsapp {
			background: #25D366;
			color: white;
		}

		.button-whatsapp:hover {
			background: #1DA851;
			transform: translateY(-1px);
			box-shadow: var(--shadow-md);
		}

		/* Footer */
		footer {
			text-align: center;
			padding: 2rem 1rem;
			color: var(--gray-600);
			font-size: 0.875rem;
		}

		/* Mobile Quick Access Button */
		.mobile-menu-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			position: fixed;
			bottom: 1rem;
			right: 1rem;
			width: 56px;
			height: 56px;
			border-radius: 50%;
			background: var(--primary-600);
			color: white;
			border: none;
			box-shadow: var(--shadow-xl);
			z-index: 100;
			cursor: pointer;
			transition: all 0.3s;
			-webkit-tap-highlight-color: transparent;
		}

		.mobile-menu-btn:active {
			transform: scale(0.95);
			background: var(--primary-700);
		}

		.mobile-menu-btn:hover {
			transform: scale(1.05);
			background: var(--primary-700);
		}

		.mobile-menu-btn svg {
			width: 24px;
			height: 24px;
		}
		
		/* Hide on larger screens if needed */
		@media (min-width: 1024px) {
			.mobile-menu-btn {
				display: none;
			}
		}

		/* Utility Classes */
		.grid {
			display: grid;
		}

		.grid-cols-1 {
			grid-template-columns: repeat(1, minmax(0, 1fr));
		}

		.gap-4 {
			gap: 1rem;
		}

		.gap-6 {
			gap: 1.5rem;
		}

		.mb-4 {
			margin-bottom: 1rem;
		}

		.mt-4 {
			margin-top: 1rem;
		}

		.flex {
			display: flex;
		}

		.flex-wrap {
			flex-wrap: wrap;
		}

		.items-center {
			align-items: center;
		}

		.justify-between {
			justify-content: space-between;
		}

		.justify-center {
			justify-content: center;
		}

		.font-bold {
			font-weight: 700;
		}

		.block {
			display: block;
		}

		/* Capture and Export Enhancements */
		#print-capture-area {
			position: absolute;
			left: -9999px;
			top: -9999px;
			max-width: 900px;
			margin: 0 auto;
			background: white;
			display: none;
		}

		.no-capture {
			display: none !important;
		}

		/* Print Styles */
		@media print {
		/* --- Print fix: Disable sticky headers, force thead/tfoot repeat, allow table page breaks ---
		   Test: Open print preview in Chrome and Firefox to verify header repeats and no sticky issues. */
		th {
		  position: static !important;
		  top: auto !important;
		  z-index: auto !important;
		}
		thead {
		  display: table-header-group !important;
		}
		tfoot {
		  display: table-footer-group !important;
		}
		table {
		  page-break-inside: auto !important;
		  -webkit-column-break-inside: auto !important;
		  break-inside: auto !important;
		}
		#print-capture-area,
		.table-container,
		div,
		section {
		  page-break-inside: auto !important;
		  -webkit-column-break-inside: auto !important;
		  break-inside: auto !important;
		}
		/* Remove any inline page-break-inside: avoid on table parents */
		[style*="page-break-inside: avoid"] {
		  page-break-inside: auto !important;
		  -webkit-column-break-inside: auto !important;
		  break-inside: auto !important;
		}
			/* Reset and clean print layout */
			* {
				box-shadow: none !important;
				text-shadow: none !important;
			}
			
			body {
				background: white !important;
				font-family: Arial, sans-serif !important;
				font-size: 10pt !important;
				line-height: 1.3 !important;
				margin: 0 !important;
				padding: 0 !important;
			}
			
			/* Hide everything except print area */
			.app-container,
			.no-print,
			header,
			nav,
			footer,
			#main-content,
			.mobile-menu-btn {
				display: none !important;
			}
			
			/* Show only print capture area */
			#print-capture-area {
				display: block !important;
				position: static !important;
				left: auto !important;
				top: auto !important;
				width: 100% !important;
				max-width: none !important;
				padding: 0.75rem !important;
				margin: 0 !important;
				background: white !important;
				page-break-inside: avoid !important;
			}
			
			/* Print Header Styling */
			#print-header {
				text-align: center !important;
				margin-bottom: 1rem !important;
				padding-bottom: 0.5rem !important;
				border-bottom: 2px solid #2563eb !important;
			}
			
			#print-header h1 {
				font-size: 16pt !important;
				font-weight: bold !important;
				color: #2563eb !important;
				margin: 0 0 0.25rem 0 !important;
			}
			
			#print-header-subtitle {
				font-size: 12pt !important;
				font-weight: 600 !important;
				color: #374151 !important;
				margin: 0.25rem 0 !important;
			}
			
			#print-header img {
				display: none !important;
			}
			
			/* Table Styling for Print */
			table {
				width: 100% !important;
				border-collapse: collapse !important;
				font-size: 8pt !important;
				margin: 0 !important;
				page-break-inside: avoid !important;
			}
			
			th {
				background: #f3f4f6 !important;
				color: #374151 !important;
				font-weight: bold !important;
				font-size: 7pt !important;
				padding: 4px 6px !important;
				border: 1px solid #d1d5db !important;
				text-align: center !important;
				line-height: 1.2 !important;
			}
			
			td {
				padding: 4px 6px !important;
				border: 1px solid #d1d5db !important;
				font-size: 7pt !important;
				line-height: 1.2 !important;
				vertical-align: top !important;
				text-align: center !important;
			}
			
			/* Content within cells */
			.subject {
				font-size: 7pt !important;
				font-weight: bold !important;
				margin: 0 0 1px 0 !important;
				color: #111827 !important;
			}
			
			.teacher {
				font-size: 6pt !important;
				color: #6b7280 !important;
				margin: 0 !important;
				line-height: 1.1 !important;
			}
			
			.substitute {
				font-size: 6pt !important;
				color: #2563eb !important;
				font-weight: bold !important;
				margin: 0 !important;
			}
			
			.line-through {
				text-decoration: line-through !important;
				opacity: 0.6 !important;
			}
			
			/* Class name styling */
			.font-bold,
			td.font-bold {
				font-weight: bold !important;
				background: #f9fafb !important;
				text-align: left !important;
			}
			
			/* Remove responsive mobile styles for print */
			.table-container {
				margin: 0 !important;
				padding: 0 !important;
				overflow: visible !important;
			}
			
			/* Disable mobile responsive table labels in print */
			table.responsive {
				border-collapse: collapse !important;
			}
			
			table.responsive thead {
				display: table-header-group !important;
			}
			
			table.responsive tr {
				display: table-row !important;
				margin: 0 !important;
				border: none !important;
				border-radius: 0 !important;
				box-shadow: none !important;
				background: transparent !important;
				overflow: visible !important;
			}
			
			table.responsive td {
				display: table-cell !important;
				width: auto !important;
				border: 1px solid #d1d5db !important;
				border-bottom: 1px solid #d1d5db !important;
				position: static !important;
			}
			
			/* Remove all pseudo-element labels */
			table.responsive td::before,
			td::before {
				display: none !important;
				content: none !important;
			}
			
			/* Force single page layout */
			@page {
				size: A4 !important;
				margin: 0.5in !important;
			}
			
			/* Prevent page breaks within important elements */
			h1, h2, h3 {
				page-break-after: avoid !important;
			}
			
			table {
				page-break-inside: avoid !important;
			}
			
			/* Ensure clean layout */
			div, span {
				page-break-inside: avoid !important;
			}
		}

		/* Enhanced Mobile Responsive Design */
		@media (max-width: 768px) {
			/* Keep flat tables on mobile (no card transformation) */
			table.responsive {
				border-collapse: collapse;
				width: 100%;
				font-size: 0.85rem;
			}
			.table-container {
				border-radius: var(--radius-lg);
				border: 1px solid var(--gray-200);
				background: white;
			}
			th {
				position: sticky;
				top: 0;
				z-index: 1;
			}
			td, th {
				padding: 0.5rem 0.4rem;
				border-bottom: 1px solid var(--gray-100);
			}
			tr:last-child td {
				border-bottom: 0;
			}

			/* Compact gaps on mobile */
			.grid-cols-md-2 {
				grid-template-columns: 1fr;
				gap: 0.75rem;
			}

			#free-teacher-finder-container .grid {
				grid-template-columns: 1fr;
				gap: 0.5rem;
			}

			.card .grid {
				grid-template-columns: 1fr;
				gap: 0.75rem;
			}

			.flex.gap-4 {
				flex-direction: column;
				gap: 0.75rem;
			}

			.flex.gap-2 {
				flex-wrap: wrap;
				gap: 0.5rem;
			}

			label {
				font-size: 0.9rem;
				font-weight: 600;
				margin-bottom: 0.5rem;
				display: block;
			}

			input[type="checkbox"] {
				width: 20px;
				height: 20px;
				margin-right: 0.75rem;
				accent-color: var(--primary-600);
			}
		}

		/* Day tabs (Mon-Sat) */
		.day-tabs {
			display: flex;
			gap: 0.25rem;
			overflow-x: auto;
			white-space: nowrap;
			scrollbar-width: thin;
			padding: 0.25rem;
			-webkit-overflow-scrolling: touch;
			border-bottom: 1px solid var(--gray-200);
			margin-bottom: 0.5rem;
		}
		.day-tab {
			appearance: none;
			border: 1px solid var(--gray-200);
			background: white;
			color: var(--gray-700);
			border-radius: 9999px;
			padding: 0.5rem 0.75rem;
			font-size: 0.85rem;
			font-weight: 600;
			cursor: pointer;
			flex: 0 0 auto;
		}
		.day-tab[aria-selected="true"], .day-tab.active {
			background: var(--primary-600);
			border-color: var(--primary-600);
			color: white;
			box-shadow: var(--shadow-md);
		}

		/* Flat list styling for mobile class/teacher day view */
		.timetable-list {
			border-radius: var(--radius-lg);
			border: 1px solid var(--gray-200);
			background: white;
			overflow: hidden;
		}
		.timetable-row {
			display: grid;
			grid-template-columns: 0.9fr 1.4fr 1.2fr;
			gap: 0.5rem;
			align-items: start;
			padding: 0.5rem 0.6rem;
			border-bottom: 1px solid var(--gray-100);
		}
		.timetable-row:last-child { border-bottom: 0; }
		.timetable-row .period-col { color: var(--gray-700); font-weight: 700; font-size: 0.85rem; }
		.timetable-row .subject-col { font-weight: 600; color: var(--gray-900); }
		.timetable-row .teacher-col { color: var(--gray-600); font-size: 0.85rem; }
		.timetable-row.is-current { background: var(--primary-50); }
		.timetable-row .extra { display: none; grid-column: 1 / -1; color: var(--gray-600); font-size: 0.8rem; }
		.timetable-row.expanded .extra { display: block; }
		@media (max-width: 420px) {
			.timetable-row { grid-template-columns: 1fr 1fr; }
			.timetable-row .teacher-col { grid-column: 2 / 3; }
		}

		/* Extra small mobile screens */
		@media (max-width: 480px) {
			.app-container {
				padding: 0.25rem;
			}
			
			.card {
				padding: 0.75rem;
				margin-bottom: 0.75rem;
			}
			
			header {
				padding: 0.75rem;
			}
			
			header h1 {
				font-size: 1.125rem;
			}
			
			.nav-button {
				padding: 0.5rem;
				min-width: 44px;
				min-height: 44px;
			}

			.nav-button svg {
				width: 18px;
				height: 18px;
			}
			
			.stat-grid {
				grid-template-columns: 1fr;
				gap: 0.5rem;
			}
			
			.stat-card {
				padding: 0.75rem;
			}
			
			.button {
				padding: 0.75rem;
				font-size: 0.85rem;
			}
			
			/* Smaller text in tables for very small screens */
			table.responsive td {
				padding: 0.5rem;
			}
			
			table.responsive td::before {
				font-size: 0.65rem;
				margin-bottom: 0.25rem;
			}
			
			.subject {
				font-size: 0.65rem;
			}
			
			.teacher, .class-name {
				font-size: 0.6rem;
			}
		}

		/* Touch Interactions and Accessibility */
		* {
			-webkit-tap-highlight-color: rgba(59, 130, 246, 0.1);
		}
		
		/* Smooth scrolling for mobile */
		html {
			scroll-behavior: smooth;
		}
		
		/* Better focus indicators for keyboard navigation */
		button:focus-visible,
		select:focus-visible,
		input:focus-visible {
			outline: 2px solid var(--primary-500);
			outline-offset: 2px;
		}
		
		/* Loading improvements for mobile */
		.spinner {
			width: 40px;
			height: 40px;
		}
		
		/* Mobile-specific utility classes */
		.mobile-only {
			display: block;
		}
		
		.desktop-only {
			display: none;
		}
		
		@media (min-width: 768px) {
			.mobile-only {
				display: none;
			}
			
			.desktop-only {
				display: block;
			}
		}

		/* Enhanced loading states */
		.loading-state {
			opacity: 0.6;
			pointer-events: none;
		}

		.pulse {
			animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: .5; }
		}

		/* Better focus states for accessibility */
		:focus-visible {
			outline: 2px solid var(--primary-500);
			outline-offset: 2px;
			border-radius: var(--radius);
		}

		/* Enhanced toast */
		.toast {
			backdrop-filter: blur(8px);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		/* Performance optimizations */
		.card, .stat-card {
			will-change: transform;
			transform: translateZ(0);
		}
	</style>
</head>
<body>
	<div id="loader">
		<div class="spinner"></div>
	</div>

	<div id="print-capture-area" style="display: none; background: white; padding: 0;">
		<div id="print-header">
			<h1 id="print-header-title">Veer Patta Public School</h1>
			<h2 id="print-header-subtitle">Timetable</h2>
			<div style="font-size: 8pt; color: #6b7280; margin-top: 0.25rem;">
				Generated on <span id="print-date"></span> at <span id="print-time"></span>
			</div>
		</div>
		<div id="print-content"></div>
	</div>

	<div class="app-container">
		<header class="no-print">
			<h1>📚 Timetable Command Center</h1>
			<p>Veer Patta Public School, Amet</p>
		</header>

		<nav class="no-print" id="main-nav">
			<button id="nav-Dashboard" class="nav-button active" onclick="switchView('Dashboard')">
				<i data-lucide="layout-dashboard"></i>
				<span>Dashboard</span>
			</button>
			<button id="nav-Day" class="nav-button" onclick="switchView('Day')">
				<i data-lucide="calendar-days"></i>
				<span>Day View</span>
			</button>
			<button id="nav-Substitution" class="nav-button" onclick="switchView('Substitution')">
				<i data-lucide="user-cog"></i>
				<span>Substitutions</span>
			</button>
			<button id="nav-Class" class="nav-button" onclick="switchView('Class')">
				<i data-lucide="school"></i>
				<span>Class View</span>
			</button>
			<button id="nav-Teacher" class="nav-button" onclick="switchView('Teacher')">
				<i data-lucide="users"></i>
				<span>Teacher View</span>
			</button>
		</nav>

		<main id="main-content" class="main-content"></main>

		<footer class="no-print">
			<p>© 2025 Veer Patta Public School | Developed with ❤️</p>
		</footer>
	</div>

	<!-- Mobile Floating Action Button: Go to Today/Now -->
	<button class="mobile-menu-btn no-print" id="fab-go-now" aria-label="Go to current period" title="Go to current period">
		<i data-lucide="clock"></i>
	</button>

	<script>
		// --- ENHANCED DATA STORE ---
		const rawData = `Monday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Home Work (Anjana),Maths (Kusum)
		Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu)
		Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Hindi (Kusum),Sports (Rakesh)
		Class 4,Hindi (Kusum),Home Work (Jainendra),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Sports (Rakesh)
		Class 5,Maths (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),CCS (Maya),Maths (Nidhika),EVS (Nidhika)
		Class 6,Science (Hemlata),Science (Hemlata),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
		Class 7,Hindi (Jainendra),Maths (Leena),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Maths (Leena),Science (Hemlata)
		Class 8,Hindi (Antima),CCS (Maya),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),Sanskrit (Antima)
		Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra),English (Harshita),Maths (Leena)
		Class 10,SST (Pradhyuman),Hindi (Antima),Maths (Nathulal),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),Sports (Rakesh)
		Class 11 Science,Physics (Phy),Physics (Phy),Biology (Hemlata),English (Pradhyuman),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Sports (Rakesh)
		Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),English (Pradhyuman),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Accountancy (Nathulal)
		Class 11 Arts,English Literature (Harshita),Geography (Prakash),Economics (Prakash),English (Pradhyuman),CCS (Maya),Sports (Rakesh),English (Pradhyuman),Political Science (Pradhyuman)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),English (Pradhyuman),Biology (Hemlata),Hindi (Jainendra),Physics (Phy)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Business (Pradhyuman),Economics (Prakash),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),CCS (Maya)
		Class 12 Arts,Geography (Prakash),English Literature (Harshita),Hindi Boards (Antima),Economics (Prakash),English (Pradhyuman),Political Science (Pradhyuman),Hindi (Jainendra),English Literature (Harshita)

		Tuesday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Hindi (Bindu),Home Work (Anjana)
		Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
		Class 3,EVS (Rashmita),Maths (Anita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Hindi (Kusum),Hindi (Kusum)
		Class 4,Hindi (Kusum),Maths (Leena),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Basic Hindi (Anjana),EVS (Anita),EVS (Anita)
		Class 5,EVS (Nidhika),Home Work (Rashmita),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Maths (Nidhika),EVS (Nidhika)
		Class 6,Science (Hemlata),Sanskrit (Jainendra),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Hindi (Jainendra),SST (Rashmita)
		Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Maths (Leena),Sanskrit (Antima)
		Class 8,Hindi (Antima),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),SST (Harshita)
		Class 9,Maths (Leena),English (Harshita),Hindi (Jainendra),CCS (Maya),Science (Toshit),Science (Toshit),Sanskrit (Antima),SST (Pradhyuman)
		Class 10,SST (Pradhyuman),CCS (Maya),Maths (Nathulal),Sanskrit (Antima),Hindi (Antima),English (Harshita),Science (Toshit),Maths (Nathulal)
		Class 11 Science,Physics (Phy),Physics (Phy),Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
		Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
		Class 11 Arts,English Literature (Harshita),Political Science (Pradhyuman),Economics (Prakash),Geography (Prakash),CCS (Maya),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Physics (Phy),Biology (Hemlata)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),CCS (Maya),Business (Pradhyuman),Hindi (Jainendra),English (Pradhyuman),Accountancy (Nathulal),Sports (Rakesh)
		Class 12 Arts,Geography (Prakash),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Sports (Rakesh)

		Wednesday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Home Work (Anjana),Hindi (Bindu),Sports (Rakesh)
		Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),Hindi (Bindu),EVS (Rashmita),Sports (Rakesh)
		Class 3,EVS (Rashmita),Home Work (Jainendra),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Maths (Anita),Maths (Anita)
		Class 4,Hindi (Kusum),EVS (Anita),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Maths (Leena),Maths (Leena),Hindi (Kusum)
		Class 5,EVS (Nidhika),EVS (Nidhika),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Hindi (Kusum),Maths (Nidhika)
		Class 6,Science (Hemlata),SST (Rashmita),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Science (Hemlata),CCS (Maya)
		Class 7,Hindi (Jainendra),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Science (Hemlata),CCS (Maya),SST (Prakash)
		Class 8,Sanskrit (Antima),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),English Boards (Rashmita),SST (Harshita),Maths (Leena)
		Class 9,Maths (Leena),Maths (Leena),Hindi (Jainendra),Science (Toshit),Sports (Rakesh),Sanskrit (Antima),SST (Pradhyuman),English (Harshita)
		Class 10,SST (Pradhyuman),English (Harshita),Science (Toshit),Maths (Nathulal),Sanskrit (Antima),Science (Toshit),Hindi (Antima),Maths (Nathulal)
		Class 11 Science,Physics (Phy),Physics (Phy),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata),Sports (Rakesh),Chemistry (Toshit),Chemistry (Toshit)
		Class 11 Commerce,CCS (Maya),Economics (Prakash),English (Pradhyuman),Self Study (Maya),Accountancy (Nathulal),Accountancy (Nathulal),Business (Nidhika),Sports (Rakesh)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),English (Pradhyuman),Geography (Prakash),Self Study (Toshit),Political Science (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),Hindi (Jainendra)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),CCS (Maya),Business (Pradhyuman),Hindi (Jainendra),English (Pradhyuman),Accountancy (Nathulal),Sports (Rakesh)
		Class 12 Arts,Geography (Prakash),Political Science (Pradhyuman),Economics (Prakash),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Hindi (Jainendra),Hindi (Jainendra)

		Thursday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,Hindi (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),EVS (Bindu),CCS (Maya),Hindi (Anjana)
		Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
		Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Home Work (Bindu),Maths (Anita)
		Class 4,Hindi (Kusum),CCS (Maya),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Games (Rakesh)
		Class 5,EVS (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),Home work (Anjana),Maths (Nidhika),Hindi (Kusum)
		Class 6,Science (Hemlata),Maths (Nidhika),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Hindi (Jainendra),Science (Hemlata),SST (Rashmita)
		Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Sanskrit (Antima),Maths (Leena)
		Class 8,Hindi (Antima),SST (Harshita),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Maths (Leena),Science (Hemlata)
		Class 9,Maths (Leena),Hindi (Jainendra),SST (Pradhyuman),SST (Pradhyuman),Sanskrit (Antima),Sanskrit (Antima),Science (Toshit),Science (Toshit)
		Class 10,SST (Pradhyuman),SST (Pradhyuman),Science (Toshit),Science (Toshit),Maths (Nathulal),Maths (Nathulal),English (Harshita),Sanskrit (Antima)
		Class 11 Science,Physics (Phy),Physics (Phy),Biology (Hemlata),Biology (Hemlata),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),English (Pradhyuman)
		Class 11 Commerce,CCS (Maya),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Hindi (Jainendra),English (Pradhyuman)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),Geography (Prakash),Self Study (Antima),Political Science (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Physics (Phy),Biology (Hemlata),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),Business (Pradhyuman),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Arts,Geography (Prakash),Self Study (Antima),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra)

		Friday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,Hindi (Bindu),Hindi (Bindu),Maths (Kusum),EVS (Bindu),Maths (Kusum),CCS (Maya),EVS (Bindu),EVS (Bindu)
		Class 2,Maths (Anita),Maths (Anita),Hindi (Bindu),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu),CCS (Maya),EVS (Rashmita)
		Class 3,EVS (Rashmita),EVS (Rashmita),Maths (Anita),Maths (Anita),CCS (Maya),Hindi (Kusum),Hindi (Kusum),Home Work (Anjana)
		Class 4,Hindi (Kusum),Hindi (Kusum),Home Work (Rashmita),CCS (Maya),Maths (Leena),Maths (Leena),EVS (Anita),EVS (Anita)
		Class 5,EVS (Nidhika),EVS (Nidhika),Basic Hindi (Antima),Hindi (Kusum),Maths (Nidhika),Maths (Nidhika),Home Work (Anjana),Sports (Rakesh)
		Class 6,Science (Hemlata),Sanskrit (Jainendra),Maths (Nidhika),Maths (Nidhika),Sanskrit (Jainendra),SST (Rashmita),SST (Rashmita),Sports (Rakesh)
		Class 7,Hindi (Jainendra),Maths (Leena),Maths (Leena),Science (Hemlata),Science (Hemlata),Sanskrit (Antima),SST (Prakash),SST (Prakash)
		Class 8,Hindi (Antima),Science (Hemlata),Science (Hemlata),Maths (Leena),Sports (Rakesh),SST (Harshita),SST (Harshita),Sanskrit (Antima)
		Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),Sanskrit (Antima),English (Harshita),Hindi (Jainendra),Sports (Rakesh),CCS (Maya)
		Class 10,SST (Pradhyuman),Sanskrit (Antima),Maths (Nathulal),English (Harshita),Hindi (Antima),Science (Toshit),Sports (Rakesh),English (Harshita)
		Class 11 Science,Physics (Phy),Physics (Phy),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata)
		Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Business (Nidhika),Business (Nidhika)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),English (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),Sports (Rakesh),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),English Literature (Harshita),Sports (Rakesh),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)

		Saturday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),EVS (Bindu),Hindi (Bindu),Hindi (Bindu),Sports (Rakesh),Maths (Kusum),Home Work (Anjana),Home Work (Bindu)
		Class 2,Maths (Anita),EVS (Rashmita),EVS (Rashmita),EVS (Rashmita),Sports (Rakesh),CCS (Maya),Hindi (Bindu),Home Work (Anita)
		Class 3,EVS (Rashmita),Maths (Anita),Hindi (Kusum),Hindi (Kusum),EVS (Rashmita),Home Work (Anjana),CCS (Maya),Home Work (Rashmita)
		Class 4,Hindi (Kusum),Hindi (Kusum),EVS (Anita),EVS (Anita),Home Work (Anjana),Maths (Leena),Maths (Leena),Maths (Leena)
		Class 5,Maths (Nidhika),Maths (Nidhika),CCS (Maya),EVS (Nidhika),EVS (Nidhika),Sports (Rakesh),Hindi (Kusum),Home Work (Anjana)
		Class 6,Science (Hemlata),Hindi (Jainendra),Maths (Nidhika),CCS (Maya),Sanskrit (Jainendra),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
		Class 7,Hindi (Jainendra),Science (Hemlata),Science (Hemlata),Maths (Leena),SST (Prakash),English Basic (Rashmita),SST (Prakash),Sports (Rakesh)
		Class 8,Hindi (Antima),Sanskrit (Antima),Maths (Leena),Science (Hemlata),CCS (Maya),SST (Harshita),SST (Harshita),Sports (Rakesh)
		Class 9,Maths (Leena),Maths (Leena),Science (Toshit),Hindi (Jainendra),Maths (Leena),SST (Pradhyuman),Science (Toshit),English (Harshita)
		Class 10,SST (Pradhyuman),SST (Pradhyuman),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),SST (Pradhyuman),Hindi (Antima)
		Class 11 Science,Physics (Phy),Physics (Phy),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Biology (Hemlata),Sports (Rakesh)
		Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Business (Nidhika)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Sports (Rakesh),Sports (Rakesh)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman)
		Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),English Literature (Harshita),Sports (Rakesh),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)`;

		// --- ENHANCED GLOBAL STATE ---
		let state = {
			currentView: 'Dashboard',
			substitutions: {},
			allData: {},
			cache: new Map(),
			lastUpdate: null,
			performance: {
				renderTimes: [],
				avgRenderTime: 0
			}
		};

		const mainContent = document.getElementById('main-content');

		// --- UTILITY FUNCTIONS ---
		function showToast(message, duration = 3000, type = 'info') {
			try {
				// Remove existing toast
				const existingToast = document.querySelector('.toast, .toast-notification');
				if (existingToast) existingToast.remove();

				// Create new toast
				const toast = document.createElement('div');
				toast.className = `toast-notification ${type}`;
				toast.innerHTML = `<span>${message}</span>`;
				
				// Ensure document body exists
				if (document.body) {
					document.body.appendChild(toast);
				} else {
					console.warn('Document body not available for toast');
					return;
				}

				// Auto-remove after duration
				setTimeout(() => {
					try {
						if (toast && toast.parentNode) {
							toast.style.opacity = '0';
							setTimeout(() => {
								if (toast && toast.parentNode) {
									toast.parentNode.removeChild(toast);
								}
							}, 300);
						}
					} catch (error) {
						console.error('Error removing toast:', error);
					}
				}, duration);
			} catch (error) {
				console.error('Error showing toast:', error);
				// Fallback to console log
				console.log(`Toast: ${message}`);
			}
		}

		function scrollToTop() {
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function isMobile() { return window.innerWidth <= 768; }

		function scrollToCurrentPeriodRow(containerSelector = '#main-content') {
			try {
				const idx = getActivePeriodIndex();
				if (idx === -1) {
					showToast('ℹ️ No live period right now', 2000, 'info');
					return;
				}
				const container = document.querySelector(containerSelector) || document;
				// Try list row first, then table cell in current period column
				let row = container.querySelector(`[data-period-index="${idx}"]`) || container.querySelector(`#row-p${idx}`);
				if (!row) {
					// Find the first cell with current-period highlight and scroll to its row
					const cell = container.querySelector('td.highlight-period, th.highlight-period');
					if (cell) row = cell.closest('tr');
				}
				if (row) {
					row.scrollIntoView({ behavior: 'smooth', block: 'center' });
					row.classList.add('is-current');
					setTimeout(() => row.classList.remove('is-current'), 2000);
				} else {
					showToast('⚠️ Current period not visible here', 2500, 'warning');
				}
			} catch (e) { console.error(e); }
		}

		function setupFab(action = 'now') {
			const fab = document.getElementById('fab-go-now');
			if (!fab) return;
			if (action === 'now') {
				fab.setAttribute('aria-label', 'Go to current period');
				fab.title = 'Go to current period';
				fab.onclick = () => scrollToCurrentPeriodRow('#main-content');
			} else if (action === 'today') {
				fab.setAttribute('aria-label', 'Go to today');
				fab.title = 'Go to today';
				fab.onclick = () => {
					try {
						const today = getCurrentDay();
						const activeTab = document.querySelector('.day-tab[aria-selected="true"]');
						if (!activeTab || activeTab.dataset.day !== today) {
							const tabBtn = document.querySelector(`.day-tab[data-day="${today}"]`);
							if (tabBtn) tabBtn.click();
							setTimeout(() => scrollToCurrentPeriodRow('#main-content'), 50);
						} else {
							scrollToCurrentPeriodRow('#main-content');
						}
					} catch (e) { console.error(e); }
				};
			}
		}

		// Swipe helpers for day switching
		function setupDaySwipeHandlers(onSwipeRight, onSwipeLeft) {
			let startX = 0, endX = 0;
			const minDist = 80;
			const el = document.getElementById('main-content');
			if (!el) return;
			el.ontouchstart = (e) => { startX = e.changedTouches[0].screenX; };
			el.ontouchend = (e) => {
				endX = e.changedTouches[0].screenX;
				const delta = endX - startX;
				if (Math.abs(delta) < minDist) return;
				if (delta > 0) onSwipeRight(); else onSwipeLeft();
			};
		}

		function switchDay(direction = 1, context = 'Day') {
			const days = state.allData.days;
			let current = getCurrentDay();
			// If a tab is active, use that instead
			const activeTab = document.querySelector('.day-tab[aria-selected="true"]');
			if (activeTab) current = activeTab.dataset.day;
			const idx = days.indexOf(current);
			const next = days[(idx + direction + days.length) % days.length];
			if (context === 'Day') renderDayView(next);
			// For mobile class/teacher, re-render corresponding mobile renderer
			if (context === 'Class') {
				const selectedClass = document.querySelector('select')?.value;
				if (selectedClass) renderClassViewMobile(selectedClass, next);
			}
			if (context === 'Teacher') {
				const selectedTeacher = document.querySelector('select')?.value;
				if (selectedTeacher) renderTeacherViewMobile(selectedTeacher, next);
			}
		}

		function debounce(func, wait) {
			let timeout;
			return function executedFunction(...args) {
				const later = () => {
					clearTimeout(timeout);
					func(...args);
				};
				clearTimeout(timeout);
				timeout = setTimeout(later, wait);
			};
		}

		function getCurrentDay() {
			const today = new Date();
			const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
			
			// Map Sunday to Monday for school context
			if (dayName === 'Sunday') return 'Monday';
			
			// Ensure the day exists in our timetable
			if (state.allData && state.allData.days && state.allData.days.includes(dayName)) {
				return dayName;
			}
			
			// Fallback to Monday
			return 'Monday';
		}

		function getCurrentPeriod() {
			const now = new Date();
			const hour = now.getHours();
			const minute = now.getMinutes();
			const timeInMinutes = hour * 60 + minute;

			// School time periods in minutes from midnight
			const periods = [
				{ start: 8 * 60 + 30, end: 9 * 60 + 10 },   // 8:30-9:10
				{ start: 9 * 60 + 10, end: 9 * 60 + 50 },   // 9:10-9:50
				{ start: 9 * 60 + 50, end: 10 * 60 + 30 },  // 9:50-10:30
				{ start: 10 * 60 + 30, end: 11 * 60 + 10 }, // 10:30-11:10
				{ start: 11 * 60 + 30, end: 12 * 60 + 10 }, // 11:30-12:10
				{ start: 12 * 60 + 10, end: 12 * 60 + 50 }, // 12:10-12:50
				{ start: 12 * 60 + 50, end: 13 * 60 + 30 }, // 12:50-13:30
				{ start: 13 * 60 + 30, end: 14 * 60 + 10 }  // 13:30-14:10
			];

			for (let i = 0; i < periods.length; i++) {
				if (timeInMinutes >= periods[i].start && timeInMinutes <= periods[i].end) {
					return i + 1;
				}
			}

			// If outside school hours, return appropriate period
			if (timeInMinutes < periods[0].start) return 1;
			return Math.min(8, periods.length);
		}

		// Returns the zero-based index of the CURRENTLY ACTIVE period, or -1 if none
		function getActivePeriodIndex() {
			const now = new Date();
			const hour = now.getHours();
			const minute = now.getMinutes();
			const timeInMinutes = hour * 60 + minute;

			const periods = [
				{ start: 8 * 60 + 30, end: 9 * 60 + 10 },   // 8:30-9:10
				{ start: 9 * 60 + 10, end: 9 * 60 + 50 },   // 9:10-9:50
				{ start: 9 * 60 + 50, end: 10 * 60 + 30 },  // 9:50-10:30
				{ start: 10 * 60 + 30, end: 11 * 60 + 10 }, // 10:30-11:10
				{ start: 11 * 60 + 30, end: 12 * 60 + 10 }, // 11:30-12:10
				{ start: 12 * 60 + 10, end: 12 * 60 + 50 }, // 12:10-12:50
				{ start: 12 * 60 + 50, end: 13 * 60 + 30 }, // 12:50-13:30
				{ start: 13 * 60 + 30, end: 14 * 60 + 10 }  // 13:30-14:10
			];

			for (let i = 0; i < periods.length; i++) {
				// Use half-open interval [start, end) to avoid double-highlighting at exact boundaries
				if (timeInMinutes >= periods[i].start && timeInMinutes < periods[i].end) {
					return i;
				}
			}
			return -1; // Before first, after last, or break
		}

		// --- ENHANCED DATA PARSING ---
		const parseTimetableData = () => {
			const timetable = {};
			const teacherDetails = {};
			let headers = [];

			try {
				// Validate rawData exists
				if (!rawData || typeof rawData !== 'string') {
					throw new Error('Raw timetable data is missing or invalid');
				}

				// Enhanced data cleaning with more robust normalization
				const correctedData = rawData
					.replace(/\(Nindika\)/g, '(Nidhika)')
					.replace(/\s+Sir/g, '')
					.replace(/english/g, 'English')
					.replace(/\r\n/g, '\n')  // Normalize line endings
					.replace(/\r/g, '\n');   // Handle different line endings

				// Normalize input: split by lines and trim each line of whitespace
				const rawLines = correctedData.split('\n');
				const normalizedLines = rawLines
					.map(line => line.trim())           // Trim whitespace from each line
					.filter(line => line.length > 0);   // Remove empty lines

				const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
				
				let currentDay = null;
				let currentDayData = [];
				
				// Process lines with improved day detection
				for (let i = 0; i < normalizedLines.length; i++) {
					const line = normalizedLines[i];
					
					// Identify class rows: check if the line starts with a day name
					if (dayNames.includes(line)) {
						// Process previous day data if exists
						if (currentDay && currentDayData.length > 0) {
							processDay(currentDay, currentDayData);
						}
						
						// Start new day
						currentDay = line;
						currentDayData = [];
					} else if (currentDay && line.length > 0) {
						// Only add non-empty lines to current day data
						currentDayData.push(line);
					}
				}
				
				// Process the last day
				if (currentDay && currentDayData.length > 0) {
					processDay(currentDay, currentDayData);
				}

				function processDay(day, dayData) {
					if (!dayData || dayData.length === 0) {
						console.warn(`No data found for ${day}`);
						return;
					}

					timetable[day] = {};
					let headerProcessed = false;
					
					// Process each line for this day
					for (let lineIndex = 0; lineIndex < dayData.length; lineIndex++) {
						const line = dayData[lineIndex].trim();
						
						if (!line) continue; // Skip empty lines
						
						// Split the line into columns, handling commas properly
						const columns = line.split(',').map(col => col.trim());
						
						if (columns.length === 0) continue;
						
						const firstColumn = columns[0];
						
						// COMPREHENSIVE HEADER SKIP CONDITION
						// Check multiple conditions to identify and skip header rows
						const isHeaderRow = (
							line.includes('Period 1') ||                    // Contains "Period 1"
							firstColumn === 'Class' ||                      // First column is exactly "Class"
							firstColumn.toLowerCase() === 'class' ||        // Case insensitive check
							line.toLowerCase().includes('period') ||        // Contains "period" anywhere
							columns.some(col => col.includes('<br>')) ||    // Any column contains <br> (time format)
							columns.some(col => col.includes('AM') || col.includes('PM')) // Contains time markers
						);
						
						if (isHeaderRow) {
							console.log(`🚫 SKIPPING HEADER: ${day} - "${line.substring(0, 100)}..."`);
							
							// Process headers only once across all days
							if (headers.length === 0 && line.includes('Period 1')) {
								headers = columns.slice(1).map(h => {
									const parts = h.split('<br>');
									return { 
										name: parts[0]?.trim() || `Period ${h}`, 
										time: parts[1]?.trim() || '' 
									};
								});
								console.log(`✅ Headers extracted: ${headers.length} periods`);
							}
							headerProcessed = true;
							continue; // CRITICAL: Skip processing this line as class data
						}
						
						// Identify ONLY valid class rows: must start with "Class " followed by a number/name
						if (firstColumn.startsWith('Class ') && 
						    firstColumn !== 'Class' && 
						    !firstColumn.toLowerCase().includes('period')) {
							const className = firstColumn;
							console.log(`✅ PROCESSING CLASS: ${day} - "${className}" with ${columns.length-1} periods`);
							
							// Ensure we have enough columns for all periods
							if (columns.length < 2) {
								console.warn(`⚠️ Insufficient data for ${className} on ${day}`);
								continue;
							}
							
							// Initialize the class schedule array
							timetable[day][className] = [];
							
							// Process each period for this class
							const periodData = columns.slice(1); // Skip the class name column
							
							periodData.forEach((cell, periodIndex) => {
								// Parse subject and teacher from the cell
								const cleanCell = cell.trim();
								
								// Default entry structure
								let entry = { 
									subject: cleanCell, 
									teacher: null, 
									period: periodIndex, 
									className: className, 
									day: day 
								};

								// Extract subject and teacher using regex
								const match = cleanCell.match(/^(.+?)\s*\(([^)]+)\)$/);
								if (match) {
									entry.subject = match[1].trim();
									entry.teacher = match[2].trim();
								}

								// Add entry to timetable
								timetable[day][className].push(entry);

								// Track teacher details for enhanced scheduling
								if (entry.teacher) {
									const teachersInCell = entry.teacher.split('/').map(t => t.trim());
									const subjectsInCell = entry.subject.split('/').map(s => s.trim());

									teachersInCell.forEach((teacherName, teacherIndex) => {
										// Initialize teacher if not exists
										if (!teacherDetails[teacherName]) {
											teacherDetails[teacherName] = { 
												schedule: {}, 
												periodCount: 0, 
												subjects: new Set(),
												workload: {}
											};
										}

										// Initialize day schedule for teacher
										if (!teacherDetails[teacherName].schedule[day]) {
											// Ensure we have the correct number of periods
											const expectedPeriods = headers.length || 8;
											teacherDetails[teacherName].schedule[day] = Array(expectedPeriods).fill(null);
										}

										// Assign subject for this teacher (handle multiple teachers per cell)
										const subjectForTeacher = subjectsInCell[teacherIndex] || subjectsInCell[0];
										
										// Correctly associate data: ensure period index is valid
										if (periodIndex < teacherDetails[teacherName].schedule[day].length) {
											teacherDetails[teacherName].schedule[day][periodIndex] = { 
												subject: subjectForTeacher, 
												className: className 
											};
										}
										
										// Update teacher statistics
										teacherDetails[teacherName].periodCount++;
										teacherDetails[teacherName].subjects.add(subjectForTeacher);

										// Calculate daily workload
										if (!teacherDetails[teacherName].workload[day]) {
											teacherDetails[teacherName].workload[day] = 0;
										}
										teacherDetails[teacherName].workload[day]++;
									});
								}
							});
						} else {
							// Debug: Log any unprocessed lines
							console.log(`❓ UNPROCESSED LINE: ${day} - "${line.substring(0, 100)}..."`);
							console.log(`   First column: "${firstColumn}"`);
							console.log(`   Starts with 'Class ': ${firstColumn.startsWith('Class ')}`);
							console.log(`   Not 'Class': ${firstColumn !== 'Class'}`);
							console.log(`   No 'period': ${!firstColumn.toLowerCase().includes('period')}`);
						}
					}
					
					console.log(`✅ Processed ${day}: ${Object.keys(timetable[day]).length} classes`);
				}

				// Validate and clean up the parsed data
				const validDays = Object.keys(timetable).filter(day => {
					return dayNames.includes(day) && Object.keys(timetable[day]).length > 0;
				});

				// Clean up timetable: remove any invalid day entries
				const cleanTimetable = {};
				validDays.forEach(day => {
					cleanTimetable[day] = timetable[day];
				});
				
				console.log(`🧹 Cleaned timetable - Valid days: ${validDays.join(', ')}`);
				console.log(`🧹 Removed invalid days: ${Object.keys(timetable).filter(d => !validDays.includes(d)).join(', ') || 'none'}`);
				
				// Update timetable reference
				Object.keys(timetable).forEach(key => delete timetable[key]);
				Object.assign(timetable, cleanTimetable);

				// Enhanced class sorting with better filtering
				let allClassNames = new Set();
				validDays.forEach(day => {
					Object.keys(timetable[day]).forEach(className => {
						// Prevent merging/splitting: only include proper class names
						if (className.startsWith('Class ') && 
							!className.toLowerCase().includes('period') &&
							className !== 'Class') {
							allClassNames.add(className);
						}
					});
				});

				const classNames = Array.from(allClassNames).sort((a, b) => {
					const extractNumber = (str) => {
						const match = str.match(/Class (\d+)/);
						return match ? parseInt(match[1]) : 999;
					};
					
					const numA = extractNumber(a);
					const numB = extractNumber(b);
					
					if (numA !== numB) return numA - numB;
					return a.localeCompare(b);
				});

				// Clean up teacher names - remove any invalid entries
				const validTeacherNames = Object.keys(teacherDetails)
					.filter(name => name && name.trim().length > 0)
					.sort();

				const result = { 
					timetable, 
					teacherDetails, 
					periodHeaders: headers, 
					classNames, 
					teacherNames: validTeacherNames,
					days: validDays
				};

				// Enhanced logging for debugging
				console.log('=== PARSING RESULTS ===');
				console.log('Valid days:', validDays);
				console.log('Classes found:', classNames.length);
				console.log('Teachers found:', validTeacherNames.length);
				console.log('Period headers:', headers.length);
				
				// Validate data integrity
				validDays.forEach(day => {
					const dayClasses = Object.keys(timetable[day]);
					console.log(`${day}: ${dayClasses.length} classes`);
					
					// Check for data consistency
					dayClasses.forEach(className => {
						const periods = timetable[day][className];
						if (periods.length !== headers.length && headers.length > 0) {
							console.warn(`${day} ${className}: Expected ${headers.length} periods, got ${periods.length}`);
						}
					});
				});
				
				// Cache the result
				state.cache.set('parsedData', result);
				state.lastUpdate = Date.now();
				
				return result;

			} catch (error) {
				console.error('Error parsing timetable data:', error);
				console.error('Error details:', error.message);
				console.error('Stack trace:', error.stack);
				
				// Return minimal data structure to prevent crashes
				return {
					timetable: { Monday: {} },
					teacherDetails: {},
					periodHeaders: [],
					classNames: [],
					teacherNames: [],
					days: ['Monday']
				};
			}
		};

		// --- ENHANCED SMART FREE TEACHER FINDER ---
		function findFreeTeachers(day, periodIndex, absentTeachers, currentDaySubs, vacantPeriod = null) {
			try {
				// Validate inputs
				if (!state.allData || !state.allData.teacherNames) {
					console.error('Teacher data not available');
					return [];
				}

				if (!state.allData.days.includes(day)) {
					console.error('Day not found in timetable:', day);
					return [];
				}

				if (periodIndex < 0 || periodIndex >= (state.allData.periodHeaders?.length || 8)) {
					console.error('Invalid period index:', periodIndex);
					return [];
				}

				const cacheKey = `smart-free-${day}-${periodIndex}-${absentTeachers.join(',')}-${JSON.stringify(currentDaySubs)}-${JSON.stringify(vacantPeriod)}`;
				if (state.cache.has(cacheKey)) {
					return state.cache.get(cacheKey);
				}

				const availableTeachers = [];
				
				// Extract vacant period details for scoring
				const vacantSubject = vacantPeriod?.subject || '';
				const vacantClassName = vacantPeriod?.className || '';
				const vacantClassGrade = extractClassGrade(vacantClassName);
				
				for (const teacher of state.allData.teacherNames) {
					// Skip if absent
					if (absentTeachers.includes(teacher)) continue;
					
					// Skip special cases or unavailable teachers
					if (teacher === 'Gyan' || teacher === 'Phy') continue;
					
					// Anjana only available after period 4
					if (teacher === 'Anjana' && periodIndex < 4) continue;

					// Check if teacher has a regular class this period
					const teacherSchedule = state.allData.teacherDetails[teacher]?.schedule[day];
					if (teacherSchedule && teacherSchedule[periodIndex]) {
						continue;
					}

					// Check if already assigned as substitute this period
					let isBusyAsSub = false;
					for (const cName in currentDaySubs) {
						if (currentDaySubs[cName][periodIndex] === teacher) {
							isBusyAsSub = true;
							break;
						}
					}
					if (isBusyAsSub) continue;

					// Calculate score for this teacher
					const score = calculateTeacherScore(teacher, day, vacantSubject, vacantClassName, vacantClassGrade, currentDaySubs);
					
					availableTeachers.push({
						teacher: teacher,
						score: score.total,
						reason: score.reason,
						breakdown: score.breakdown
					});
				}

				// Sort by score (highest first), then by teacher name for consistency
				availableTeachers.sort((a, b) => {
					if (b.score !== a.score) {
						return b.score - a.score;
					}
					return a.teacher.localeCompare(b.teacher);
				});

				console.log(`Smart teacher recommendations for ${day} period ${periodIndex + 1}:`, availableTeachers.slice(0, 5));

				state.cache.set(cacheKey, availableTeachers);
				return availableTeachers;

			} catch (error) {
				console.error('Error finding free teachers:', error);
				return [];
			}
		}

		// --- TEACHER SCORING ALGORITHM ---
		function calculateTeacherScore(teacher, day, vacantSubject, vacantClassName, vacantClassGrade, currentDaySubs) {
			try {
				let score = 0;
				let reason = '';
				const breakdown = {
					subjectMatch: 0,
					gradeMatch: 0,
					workloadBonus: 0,
					availabilityBonus: 0
				};

				const teacherData = state.allData.teacherDetails[teacher];
				if (!teacherData) {
					return { total: 0, reason: 'No data available', breakdown };
				}

				// Get teacher's subjects and classes
				const teacherSubjects = Array.from(teacherData.subjects || []);
				const teacherClasses = getTeacherClasses(teacher, day);
				const teacherGrades = teacherClasses.map(extractClassGrade);

				// 1. HIGHEST PRIORITY: Subject Match (40 points max)
				if (vacantSubject && teacherSubjects.length > 0) {
					const subjectMatch = findBestSubjectMatch(vacantSubject, teacherSubjects);
					if (subjectMatch.score > 0) {
						breakdown.subjectMatch = subjectMatch.score;
						score += subjectMatch.score;
						reason = subjectMatch.reason;
					}
				}

				// 2. MEDIUM PRIORITY: Grade/Class Match (25 points max)
				if (vacantClassGrade && teacherGrades.length > 0) {
					if (teacherGrades.includes(vacantClassGrade)) {
						breakdown.gradeMatch = 25;
						score += 25;
						if (!reason) reason = `Teaches Grade ${vacantClassGrade}`;
					} else {
						// Partial points for nearby grades
						const gradeBonus = calculateGradeProximity(vacantClassGrade, teacherGrades);
						breakdown.gradeMatch = gradeBonus;
						score += gradeBonus;
						if (!reason && gradeBonus > 0) reason = `Teaches nearby grades`;
					}
				}

				// 3. LOW PRIORITY: Workload considerations (20 points max)
				const currentWorkload = teacherData.workload[day] || 0;
				const substitutionWorkload = calculateSubstitutionWorkload(teacher, day, currentDaySubs);
				const totalWorkload = currentWorkload + substitutionWorkload;
				
				// Bonus for teachers with lower workload
				const maxWorkload = 8; // Maximum periods per day
				const workloadBonus = Math.max(0, Math.round((maxWorkload - totalWorkload) * 2.5));
				breakdown.workloadBonus = workloadBonus;
				score += workloadBonus;

				// 4. AVAILABILITY BONUS: Experience and reliability (15 points max)
				const availabilityBonus = calculateAvailabilityBonus(teacher, teacherData);
				breakdown.availabilityBonus = availabilityBonus;
				score += availabilityBonus;

				// Set default reason if none found
				if (!reason) {
					if (score > 15) reason = 'Good general availability';
					else if (score > 5) reason = 'Available teacher';
					else reason = 'Last resort option';
				}

				return {
					total: Math.max(0, score),
					reason: reason,
					breakdown: breakdown
				};

			} catch (error) {
				console.error('Error calculating teacher score:', error);
				return { total: 0, reason: 'Error in calculation', breakdown: {} };
			}
		}

		// --- HELPER FUNCTIONS FOR SCORING ---
		function extractClassGrade(className) {
			if (!className) return null;
			const match = className.match(/(\d+)/);
			return match ? parseInt(match[1]) : null;
		}

		function getTeacherClasses(teacher, day) {
			try {
				const teacherData = state.allData.teacherDetails[teacher];
				if (!teacherData || !teacherData.schedule[day]) return [];
				
				const classes = [];
				teacherData.schedule[day].forEach(period => {
					if (period && period.className && !classes.includes(period.className)) {
						classes.push(period.className);
					}
				});
				return classes;
			} catch (error) {
				console.error('Error getting teacher classes:', error);
				return [];
			}
		}

		function findBestSubjectMatch(vacantSubject, teacherSubjects) {
			const vacantLower = vacantSubject.toLowerCase().trim();
			
			// Exact match
			for (const subject of teacherSubjects) {
				if (subject.toLowerCase().trim() === vacantLower) {
					return { score: 40, reason: `Teaches ${subject}` };
				}
			}

			// Partial matches with scoring
			const partialMatches = [
				{ patterns: ['english', 'elga'], score: 35, name: 'English' },
				{ patterns: ['hindi'], score: 35, name: 'Hindi' },
				{ patterns: ['maths', 'mathematics'], score: 35, name: 'Mathematics' },
				{ patterns: ['science', 'physics', 'chemistry', 'biology'], score: 35, name: 'Science' },
				{ patterns: ['sst', 'social', 'history', 'geography', 'civics'], score: 30, name: 'Social Studies' },
				{ patterns: ['sanskrit'], score: 30, name: 'Sanskrit' },
				{ patterns: ['sports', 'games', 'physical'], score: 25, name: 'Physical Education' },
				{ patterns: ['ccs', 'computer'], score: 25, name: 'Computer Science' },
				{ patterns: ['evs', 'environmental'], score: 25, name: 'Environmental Studies' },
				{ patterns: ['accountancy', 'accounts'], score: 30, name: 'Accountancy' },
				{ patterns: ['economics'], score: 30, name: 'Economics' },
				{ patterns: ['business'], score: 30, name: 'Business Studies' },
				{ patterns: ['political'], score: 25, name: 'Political Science' }
			];

			for (const match of partialMatches) {
				if (match.patterns.some(pattern => vacantLower.includes(pattern))) {
					for (const subject of teacherSubjects) {
						const subjectLower = subject.toLowerCase();
						if (match.patterns.some(pattern => subjectLower.includes(pattern))) {
							return { score: match.score, reason: `Teaches related subject (${match.name})` };
						}
					}
				}
			}

			return { score: 0, reason: '' };
		}

		function calculateGradeProximity(vacantGrade, teacherGrades) {
			if (!vacantGrade || !teacherGrades.length) return 0;
			
			let bestProximity = 0;
			for (const grade of teacherGrades) {
				if (grade === null) continue;
				
				const distance = Math.abs(vacantGrade - grade);
				let proximityPoints = 0;
				
				if (distance === 0) proximityPoints = 25; // Exact match
				else if (distance === 1) proximityPoints = 15; // Adjacent grade
				else if (distance === 2) proximityPoints = 10; // 2 grades away
				else if (distance <= 3) proximityPoints = 5;  // 3 grades away
				
				bestProximity = Math.max(bestProximity, proximityPoints);
			}
			
			return bestProximity;
		}

		function calculateSubstitutionWorkload(teacher, day, currentDaySubs) {
			let substitutionCount = 0;
			for (const cName in currentDaySubs) {
				for (const period in currentDaySubs[cName]) {
					if (currentDaySubs[cName][period] === teacher) {
						substitutionCount++;
					}
				}
			}
			return substitutionCount;
		}

		function calculateAvailabilityBonus(teacher, teacherData) {
			let bonus = 10; // Base availability bonus
			
			// Experience bonus based on total periods
			const totalPeriods = teacherData.periodCount || 0;
			if (totalPeriods > 30) bonus += 5; // Very experienced
			else if (totalPeriods > 20) bonus += 3; // Experienced
			else if (totalPeriods < 10) bonus -= 2; // Less experienced
			
			// Subject diversity bonus
			const subjectCount = teacherData.subjects ? teacherData.subjects.size : 0;
			if (subjectCount > 3) bonus += 3;
			else if (subjectCount > 1) bonus += 1;
			
			// Reliability adjustments for specific teachers
			const reliabilityAdjustments = {
				'Hemlata': 2,    // Science specialist
				'Pradhyuman': 2, // Senior teacher
				'Nathulal': 2,   // Math specialist
				'Harshita': 1,   // English specialist
				'Jainendra': 1,  // Hindi specialist
				'Antima': 1,     // Sanskrit specialist
				'Maya': -1,      // Limited availability
				'Rakesh': -2     // Sports only
			};
			
			if (reliabilityAdjustments[teacher]) {
				bonus += reliabilityAdjustments[teacher];
			}
			
			return Math.max(0, Math.min(15, bonus)); // Cap between 0-15
		}

		// --- ENHANCED FREE TEACHER FINDER RENDER ---
		function renderFreeTeacherFinder(day = null, period = null) {
			try {
				const container = document.getElementById('free-teacher-finder-container');
				if (!container) {
					console.error('Free teacher finder container not found');
					return;
				}

				// Ensure we have data
				if (!state.allData || !state.allData.days || state.allData.days.length === 0) {
					container.innerHTML = `
						<div style="color: var(--red-500); padding: 2rem; text-align: center; border: 2px dashed var(--red-200); border-radius: var(--radius);">
							<i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i><br>
							Data not loaded yet. Please wait...
						</div>
					`;
					if (typeof lucide !== 'undefined' && lucide.createIcons) {
						lucide.createIcons();
					}
					return;
				}

				// Smart defaults based on current time
				const currentDay = day || getCurrentDay();
				const currentPeriod = period || getCurrentPeriod();
				const periodIndex = currentPeriod - 1;

				// Validate that the selected day exists
				if (!state.allData.days.includes(currentDay)) {
					container.innerHTML = `
						<div style="color: var(--red-500); padding: 2rem; text-align: center; border: 2px dashed var(--red-200); border-radius: var(--radius);">
							<i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i><br>
							Day "${currentDay}" not found in timetable data.
						</div>
					`;
					lucide.createIcons();
					return;
				}

				const freeTeachers = findFreeTeachers(currentDay, periodIndex, [], {});

				const dayOptions = state.allData.days.map(d =>
					`<option value="${d}" ${d === currentDay ? 'selected' : ''}>${d}</option>`
				).join('');

				const periodOptions = state.allData.periodHeaders.map((p, i) =>
					`<option value="${i+1}" ${i+1 == currentPeriod ? 'selected' : ''}>${p.name} ${p.time ? `(${p.time})` : ''}</option>`
				).join('');

				const freeTeachersList = freeTeachers.length > 0
					? freeTeachers.map((teacherObj, index) => {
						const teacher = teacherObj.teacher;
						const workload = state.allData.teacherDetails[teacher]?.workload[currentDay] || 0;
						const substitutionWorkload = calculateSubstitutionWorkload(teacher, currentDay, {});
						const totalWorkload = workload + substitutionWorkload;
						
						// Color coding based on score
						let borderColor = 'var(--gray-400)';
						let bgColor = 'var(--gray-50)';
						let textColor = 'var(--gray-800)';
						
						if (teacherObj.score >= 35) {
							borderColor = 'var(--green-500)';
							bgColor = 'var(--green-50)';
							textColor = 'var(--green-800)';
						} else if (teacherObj.score >= 20) {
							borderColor = 'var(--primary-500)';
							bgColor = 'var(--primary-50)';
							textColor = 'var(--primary-800)';
						} else if (teacherObj.score >= 10) {
							borderColor = 'var(--yellow-500)';
							bgColor = 'var(--yellow-50)';
							textColor = 'var(--yellow-800)';
						}

						const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;

						return `
							<div style="background: ${bgColor}; color: ${textColor}; padding: 0.875rem;
										border-radius: var(--radius); font-size: 0.875rem;
										border-left: 4px solid ${borderColor}; margin-bottom: 0.5rem;
										box-shadow: var(--shadow-sm);">
								<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
									<div style="display: flex; align-items: center; gap: 0.5rem;">
										<span style="font-weight: 600;">${rankIcon} ${teacher}</span>
										<span style="background: rgba(255,255,255,0.7); padding: 0.2rem 0.4rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600;">
											Score: ${teacherObj.score}
										</span>
									</div>
									<small style="opacity: 0.8; font-size: 0.75rem;">
										${totalWorkload} periods today
									</small>
								</div>
								<div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">
									<strong>Reason:</strong> ${teacherObj.reason}
								</div>
								${teacherObj.breakdown ? `
									<div style="font-size: 0.7rem; opacity: 0.7; display: flex; gap: 1rem; flex-wrap: wrap;">
										${teacherObj.breakdown.subjectMatch > 0 ? `<span>Subject: +${teacherObj.breakdown.subjectMatch}</span>` : ''}
										${teacherObj.breakdown.gradeMatch > 0 ? `<span>Grade: +${teacherObj.breakdown.gradeMatch}</span>` : ''}
										${teacherObj.breakdown.workloadBonus > 0 ? `<span>Workload: +${teacherObj.breakdown.workloadBonus}</span>` : ''}
										${teacherObj.breakdown.availabilityBonus > 0 ? `<span>Availability: +${teacherObj.breakdown.availabilityBonus}</span>` : ''}
									</div>
								` : ''}
							</div>
						`;
					}).join('')
					: `<div style="color: var(--gray-500); padding: 2rem; text-align: center; border: 2px dashed var(--gray-200); border-radius: var(--radius);">
					   <i data-lucide="user-x" style="width: 24px; height: 24px; margin-bottom: 0.5rem; color: var(--gray-400);"></i><br>
					   No teachers are free for this slot.
				   </div>`;

				const currentTime = new Date().toLocaleTimeString('en-US', { 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: true
				});

				const html = `
					<div style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--blue-50) 100%); 
								padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;
								border: 1px solid var(--primary-200);">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<div>
								<strong style="color: var(--primary-700);">Current Time: ${currentTime}</strong>
							</div>
							<div style="display: flex; align-items: center; gap: 0.5rem;">
								<div style="width: 8px; height: 8px; background: var(--green-500); border-radius: 50%; animation: pulse 2s infinite;"></div>
								<small style="color: var(--primary-600); font-weight: 500;">Live Updates</small>
							</div>
						</div>
						<small style="color: var(--primary-600);">
							Showing free teachers for ${currentDay}, Period ${currentPeriod}
						</small>
					</div>
					
					<div class="grid grid-cols-1 grid-cols-md-2 gap-4 mb-4">
						<div>
							<label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--gray-700);">
								<i data-lucide="calendar" style="width: 16px; height: 16px; display: inline; margin-right: 0.25rem;"></i>
								Day
							</label>
							<select id="finder-day-select" style="border: 2px solid var(--primary-200);">${dayOptions}</select>
						</div>
						<div>
							<label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--gray-700);">
								<i data-lucide="clock" style="width: 16px; height: 16px; display: inline; margin-right: 0.25rem;"></i>
								Period
							</label>
							<select id="finder-period-select" style="border: 2px solid var(--primary-200);">${periodOptions}</select>
						</div>
					</div>
					
					<div style="max-height: 20rem; overflow-y: auto; padding: 0.5rem;
								background: var(--gray-50); border-radius: var(--radius-lg);
								border: 1px solid var(--gray-200);">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
							<h4 style="color: var(--gray-700); margin: 0;">
								<i data-lucide="users-check" style="width: 18px; height: 18px; display: inline; margin-right: 0.5rem;"></i>
								Smart Teacher Recommendations
							</h4>
							<span style="background: var(--primary-600); color: white; padding: 0.25rem 0.5rem; 
									 border-radius: var(--radius); font-size: 0.75rem; font-weight: 600;">
							${freeTeachers.length} available
						</span>
						</div>
						${freeTeachers.length > 0 ? `
							<div style="background: var(--blue-50); padding: 0.5rem; border-radius: var(--radius); margin-bottom: 0.75rem; border-left: 3px solid var(--blue-500);">
								<p style="font-size: 0.75rem; color: var(--blue-800); margin: 0;">
									<i data-lucide="info" style="width: 12px; height: 12px; display: inline; margin-right: 0.25rem;"></i>
									Teachers ranked by: Subject expertise → Grade familiarity → Workload balance → Availability
								</p>
							</div>
						` : ''}
						<div style="display: flex; flex-direction: column; gap: 0.5rem;">
							${freeTeachersList}
						</div>
					</div>
				`;

				container.innerHTML = html;

				// Enhanced event listeners with error handling
				const daySelect = document.getElementById('finder-day-select');
				const periodSelect = document.getElementById('finder-period-select');
				
				if (daySelect) {
					daySelect.addEventListener('change', (e) => {
						try {
							const newDay = e.target.value;
							const newPeriod = document.getElementById('finder-period-select')?.value || period;
							renderFreeTeacherFinder(newDay, newPeriod);
						} catch (error) {
							console.error('Error in day select change:', error);
						}
					});
				}

				if (periodSelect) {
					periodSelect.addEventListener('change', (e) => {
						try {
							const newDay = document.getElementById('finder-day-select')?.value || day;
							const newPeriod = e.target.value;
							renderFreeTeacherFinder(newDay, newPeriod);
						} catch (error) {
							console.error('Error in period select change:', error);
						}
					});
				}

				if (typeof lucide !== 'undefined' && lucide.createIcons) {
					lucide.createIcons();
				}

			} catch (error) {
				console.error('Error rendering free teacher finder:', error);
				container.innerHTML = `
					<div style="color: var(--red-500); padding: 2rem; text-align: center; border: 2px dashed var(--red-200); border-radius: var(--radius);">
						<i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i><br>
						Error loading free teacher finder. Please refresh the page.
					</div>
				`;
				lucide.createIcons();
			}
		}

		const debouncedRenderFreeTeacher = debounce(renderFreeTeacherFinder, 300);

		// --- DASHBOARD RENDER ---
		function renderDashboard() {
			try {
				// Place Live Free Teacher Finder at the very top and remove extra stat cards
				const html = `
					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
							<i data-lucide=\"search\" style=\"width: 20px; height: 20px;\"></i>
							Live Free Teacher Finder
						</h2>
						<div id=\"free-teacher-finder-container\"></div>
					</div>

					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
							<i data-lucide=\"zap\" style=\"width: 20px; height: 20px;\"></i>
							Quick Actions
						</h2>
						<div class="grid grid-cols-1 grid-cols-md-2 gap-4">
							<button class="button button-primary" onclick="switchView('Day')" style="background: linear-gradient(135deg, var(--primary-600), var(--primary-700));">
								<i data-lucide="calendar"></i> 
								<span class="mobile-only">Today's Schedule</span>
								<span class="desktop-only">View Today's Schedule</span>
							</button>
							<button class="button button-primary" onclick="switchView('Substitution')" style="background: linear-gradient(135deg, var(--green-500), var(--green-600));">
								<i data-lucide="user-cog"></i>
								<span class="mobile-only">Substitutions</span>
								<span class="desktop-only">Manage Substitutions</span>
							</button>
							<button class="button button-secondary" onclick="switchView('Class')" style="background: linear-gradient(135deg, var(--yellow-500), var(--yellow-600)); color: white;">
								<i data-lucide="school"></i>
								<span class="mobile-only">Classes</span>
								<span class="desktop-only">Browse Classes</span>
							</button>
							<button class="button button-secondary" onclick="switchView('Teacher')" style="background: linear-gradient(135deg, var(--red-500), var(--red-600)); color: white;">
								<i data-lucide="users"></i>
								<span class="mobile-only">Teachers</span>
								<span class="desktop-only">Teacher Schedules</span>
							</button>
						</div>
					</div>

					<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
						<button onclick="handlePrint()" class="button button-secondary" style="max-width:250px;">
							<i data-lucide="printer"></i> Print Complete Timetable
						</button>
					</div>
				`;

				mainContent.innerHTML = html;
				renderFreeTeacherFinder();
				lucide.createIcons();

				// Auto-refresh free teachers every 30 seconds
				if (!window.dashboardInterval) {
					window.dashboardInterval = setInterval(() => {
						if (state.currentView === 'Dashboard') {
							renderFreeTeacherFinder();
						}
					}, 30000);
				}

			} catch (error) {
				console.error('Error rendering dashboard:', error);
				mainContent.innerHTML = `
					<div class="card">
						<div style="color: var(--red-500); padding: 2rem; text-align: center;">
							<i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><br>
							<h3>Error Loading Dashboard</h3>
							<p>Please refresh the page to try again.</p>
						</div>
					</div>
				`;
				lucide.createIcons();
			}
		}

		// --- FIXED DAY VIEW RENDER ---
		function renderDayView(day = null) {
			try {
				const selectedDay = day || getCurrentDay();
				const { timetable, classNames, periodHeaders } = state.allData;

				// Validate that the selected day exists in timetable
				if (!timetable[selectedDay]) {
					console.error(`Day ${selectedDay} not found in timetable`);
					showToast(`❌ No timetable data found for ${selectedDay}`);
					return;
				}

				const daySubs = state.substitutions[selectedDay]?.plan || {};

				// Day tabs (Mon-Sat)
				const tabs = state.allData.days.map(d => `
					<button class="day-tab ${selectedDay===d?'active':''}" role="tab" aria-selected="${selectedDay===d}" data-day="${d}" onclick="renderDayView('${d}')">${d.slice(0,3)}</button>
				`).join('');

				document.getElementById('print-header-subtitle').textContent = `Daily Schedule for ${selectedDay}`;


				// Determine current period index for highlighting (only if actually live)
				let currentPeriodIdx = -1;
				if (selectedDay === getCurrentDay() && typeof getActivePeriodIndex === 'function') {
					currentPeriodIdx = getActivePeriodIndex();
				}

					const tableHeader = '<th role="columnheader">Class</th>' + periodHeaders.map((h, idx) =>
						`<th role="columnheader"${idx === currentPeriodIdx ? ' class="highlight-period"' : ''}>${h.name}<br/><span style="font-weight:400; font-size: 0.75rem;">${h.time}</span></th>`
					).join('');				const tableBody = classNames.map(cName => {
					if (!timetable[selectedDay][cName]) {
						console.warn(`Class ${cName} not found for ${selectedDay}`);
						return '';
					}
					return `
						<tr>
							<td class="font-bold" data-label="Class">${cName}</td>
							${timetable[selectedDay][cName].map((period, i) => {
								const substitute = daySubs[cName]?.[i];
								const label = `${periodHeaders[i]?.name || `Period ${i+1}`} (${periodHeaders[i]?.time || ''})`;
								return `
									<td data-label="${label}"${i === currentPeriodIdx ? ' class="highlight-period"' : ''}>
										<div class="subject">${period.subject || 'No Subject'}</div>
										${period.teacher ? `<div class="teacher ${substitute ? 'line-through' : ''}">${period.teacher}</div>` : ''}
										${substitute ? `<div class="teacher substitute">Sub: ${substitute}</div>` : ''}
									</td>
								`;
							}).join('')}
						</tr>
					`;
				}).filter(row => row).join('');

				const html = `
					<div class="card">
						<div class="flex items-center justify-between flex-wrap gap-4">
							<h2 style="font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
								<i data-lucide="calendar-days"></i>
								${selectedDay} Schedule
								${selectedDay === getCurrentDay() && currentPeriodIdx !== -1 ? '<span style="color: var(--red-500); font-size: 0.75rem;">● LIVE</span>' : ''}
							</h2>
							<div class="flex gap-2">
								<button onclick="handlePrint()" class="button button-secondary" style="width: auto; font-size: 0.75rem; padding: 0.5rem 0.75rem;">
									<i data-lucide="printer"></i> Print ${selectedDay}
								</button>
								<button onclick="handleShareScreenshot()" class="button button-whatsapp" style="width: auto;">
									<i data-lucide="share-2"></i>
								</button>
								<button onclick="handleShareAsPDF()" class="button button-primary no-capture" style="width: auto; font-size: 0.75rem; padding: 0.5rem 0.75rem;">
									<i data-lucide="file-text"></i> PDF
								</button>
								<button onclick="handleExportCSV()" class="button button-secondary no-capture" style="width: auto; font-size: 0.75rem; padding: 0.5rem 0.75rem;">
									<i data-lucide="download"></i> CSV
								</button>
							</div>
						</div>
						<div class="day-tabs" role="tablist" aria-label="Select day">
							${tabs}
						</div>
						<div class="table-container sticky-first-col">
							<table class="responsive" role="table" aria-label="${selectedDay} timetable by class">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>${tableBody}</tbody>
							</table>
						</div>
					</div>
				`;

				mainContent.innerHTML = html;
				lucide.createIcons();
				setupFab('today');

				// Add horizontal swipe between days on mobile
				if (isMobile()) {
					setupDaySwipeHandlers(() => switchDay(-1, 'Day'), () => switchDay(1, 'Day'));
				}

			} catch (error) {
				console.error('Error rendering day view:', error);
				mainContent.innerHTML = `
					<div class="card">
						<div style="color: var(--red-500); padding: 2rem; text-align: center;">
							<i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><br>
							<h3>Error Loading Day View</h3>
							<p>Failed to load schedule for ${day || getCurrentDay()}. Please try again.</p>
							<button onclick="switchView('Dashboard')" class="button button-primary" style="margin-top: 1rem; max-width: 200px;">
								Return to Dashboard
							</button>
						</div>
					</div>
				`;
				lucide.createIcons();
			}
		}

		// --- COMPLETE MISSING RENDER FUNCTIONS ---
		function renderClassView(selectedClass = '') {
			try {
				const { timetable, classNames, periodHeaders } = state.allData;
				document.getElementById('print-header-subtitle').textContent =
					selectedClass ? `Weekly Schedule for ${selectedClass}` : 'Class Timetables';

				const classOptions = '<option value="">-- Select a Class --</option>' +
					classNames.map(c =>
						`<option value="${c}" ${c === selectedClass ? 'selected' : ''}>${c}</option>`
					).join('');

				let tableHtml = '';

				// Mobile: Show day tabs and flat list of periods for the selected class
				if (isMobile() && selectedClass) {
					const days = state.allData.days;
					const selectedDay = getCurrentDay();
					const tabs = days.map(d => `
						<button class="day-tab" role="tab" aria-selected="${d===selectedDay}" data-day="${d}" onclick="renderClassViewMobile('${selectedClass}','${d}')">${d.slice(0,3)}</button>
					`).join('');
					tableHtml = `
						<div class="day-tabs" role="tablist" aria-label="Select day">
							${tabs}
						</div>
						<div id="class-mobile-container"></div>
					`;
				}

		if (selectedClass && timetable.Monday && timetable.Monday[selectedClass]) {
			// Highlight current period if today
			let currentPeriodIdx = -1;
			let today = getCurrentDay();
			if (typeof getActivePeriodIndex === 'function') {
				currentPeriodIdx = getActivePeriodIndex();
			}
			const tableHeader = '<th>Day</th>' + periodHeaders.map((h, idx) =>
				`<th${(today && idx === currentPeriodIdx) ? ' class="highlight-period"' : ''}>${h.name}<br/><span style="font-weight:400; font-size: 0.75rem;">${h.time}</span></th>`
			).join('');

			const validDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
			const tableBody = Object.keys(timetable)
				.filter(day => validDays.includes(day)) // Only include valid days
				.map(day => {
					const daySchedule = timetable[day][selectedClass] || [];
					const daySubs = state.substitutions[day]?.plan || {};
					return `
						<tr>
							<td class="font-bold" data-label="Day">${day}</td>
						${periodHeaders.map((_, i) => {
							const originalPeriod = daySchedule[i];
							const isSubstitutedOut = originalPeriod && daySubs[originalPeriod.className]?.[i];
							const substitute = originalPeriod ? (daySubs[originalPeriod.className]?.[i] || null) : null;
							const label = periodHeaders[i]?.name || `Period ${i+1}`;
							return `
								<td data-label="${label}"${(day === today && i === currentPeriodIdx) ? ' class="highlight-period"' : ''}>
									${originalPeriod ? `
										<div class="${isSubstitutedOut ? 'line-through' : ''}">
											<div class="subject">${originalPeriod.subject}</div>
											<div class="class-name">${originalPeriod.className}</div>
										</div>
										${substitute ? `<div class="teacher substitute">Sub: ${substitute}</div>` : ''}
									` : ''}
								</td>
							`;
						}).join('')}
					</tr>
				`;
			}).join('');

					tableHtml = `
						<div class="table-container">
							<table class="responsive sticky-first-col" role="table" aria-label="${selectedClass} weekly timetable">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>${tableBody}</tbody>
							</table>
						</div>
						<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
							<button onclick="handlePrint()" class="button button-secondary" style="max-width: 250px;">
								<i data-lucide="printer"></i> Print ${selectedClass} Schedule
							</button>
							<button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
								<i data-lucide="share-2"></i> Share
							</button>
							<button onclick="handleShareAsPDF()" class="button button-primary no-capture" style="max-width: 200px;">
								<i data-lucide="file-text"></i> Share as PDF
							</button>
							<button onclick="handleExportCSV()" class="button button-secondary no-capture" style="max-width: 200px;">
								<i data-lucide="download"></i> Export CSV
							</button>
						</div>
					`;
				}

				const html = `
					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
							🏫 View by Class
						</h2>
						<select onchange="renderClassView(this.value)">${classOptions}</select>
						${tableHtml}
					</div>
				`;

				mainContent.innerHTML = html;
				lucide.createIcons();

				if (isMobile() && selectedClass) {
					renderClassViewMobile(selectedClass, getCurrentDay());
					setupFab('today');
					setupDaySwipeHandlers(() => switchDay(-1, 'Class'), () => switchDay(1, 'Class'));
				} else {
					setupFab('now');
				}

			} catch (error) {
				console.error('Error rendering class view:', error);
				showToast('❌ Error loading class view');
			}
		}

		// Render mobile class view for a specific day
		function renderClassViewMobile(selectedClass, day) {
			try {
				const { timetable, periodHeaders } = state.allData;
				const container = document.getElementById('class-mobile-container');
				if (!container) return;
				// Update tab selection state
				document.querySelectorAll('.day-tab').forEach(btn => {
					btn.setAttribute('aria-selected', String(btn.dataset.day === day));
					btn.classList.toggle('active', btn.dataset.day === day);
				});
				const periods = timetable[day]?.[selectedClass] || [];
				const today = getCurrentDay();
				const activeIdx = day === today ? getActivePeriodIndex() : -1;
				const list = periods.map((p, i) => {
					const label = periodHeaders[i]?.name || `P${i+1}`;
					const time = periodHeaders[i]?.time || '';
					return `
						<div class="timetable-row ${i===activeIdx?'is-current':''}" data-period-index="${i}" id="row-p${i}" role="button" tabindex="0" onclick="this.classList.toggle('expanded')" onkeypress="if(event.key==='Enter') this.click()">
							<div class="period-col">${label}<div style="font-weight:500; color: var(--gray-500); font-size: 0.75rem;">${time}</div></div>
							<div class="subject-col">${p?.subject || ''}</div>
							<div class="teacher-col">${p?.teacher || ''}</div>
							<div class="extra">Class: ${selectedClass}</div>
						</div>`;
				}).join('');
				container.innerHTML = `<div class="timetable-list" aria-label="${selectedClass} - ${day}">${list}</div>`;
			} catch (e) { console.error(e); }
		}

		function renderTeacherView(selectedTeacher = '') {
			try {
				const { teacherDetails, teacherNames, periodHeaders, timetable } = state.allData;
				document.getElementById('print-header-subtitle').textContent =
					selectedTeacher ? `Weekly Schedule for ${selectedTeacher}` : 'Teacher Timetables';

				const teacherOptions = '<option value="">-- Select a Teacher --</option>' +
					teacherNames.map(t =>
						`<option value="${t}" ${t === selectedTeacher ? 'selected' : ''}>${t}</option>`
					).join('');

				let detailsHtml = '';
				if (selectedTeacher && teacherDetails[selectedTeacher]) {

					// Mobile: day tabs + flat list
					if (isMobile()) {
						const days = state.allData.days;
						const selectedDay = getCurrentDay();
						const tabs = days.map(d => `
							<button class="day-tab" role="tab" aria-selected="${d===selectedDay}" data-day="${d}" onclick="renderTeacherViewMobile('${selectedTeacher}','${d}')">${d.slice(0,3)}</button>
						`).join('');
						detailsHtml = `
							<div class="mt-4">
								<div style="background: var(--primary-50); color: var(--primary-800); font-weight: 600; text-align: center; border-radius: var(--radius); padding: 0.5rem; margin-bottom: 0.75rem;">
									Total Weekly Periods: ${teacherDetails[selectedTeacher].periodCount}
								</div>
								<div class="day-tabs" role="tablist" aria-label="Select day">
									${tabs}
								</div>
								<div id="teacher-mobile-container"></div>
							</div>
						`;
					}

		// Highlight current period if today (only when actually live)
		let currentPeriodIdx = -1;
		let today = getCurrentDay();
		if (typeof getActivePeriodIndex === 'function') {
			currentPeriodIdx = getActivePeriodIndex();
		}
		const tableHeader = '<th>Day</th>' + periodHeaders.map((h, idx) => `<th${(today && idx === currentPeriodIdx) ? ' class="highlight-period"' : ''}>${h.name}</th>`).join('');
		const tableBody = Object.keys(timetable).map(day => {
			const daySchedule = teacherDetails[selectedTeacher].schedule[day] || [];
			const daySubs = state.substitutions[day]?.plan || {};
			return `
				<tr>
					<td class="font-bold" data-label="Day">${day}</td>
					${periodHeaders.map((_, i) => {
						const originalPeriod = daySchedule[i];
						const isSubstitutedOut = originalPeriod && daySubs[originalPeriod.className]?.[i];
						let subPeriodInfo = null;
						for (const cName in daySubs) {
							if (daySubs[cName][i] === selectedTeacher) {
								subPeriodInfo = timetable[day][cName][i];
								break;
							}
						}
						const label = periodHeaders[i]?.name || `Period ${i+1}`;
						return `
							<td data-label="${label}"${(day === today && i === currentPeriodIdx) ? ' class="highlight-period"' : ''}>
								${originalPeriod ? `
									<div class="${isSubstitutedOut ? 'line-through' : ''}">
										<div class="subject">${originalPeriod.subject}</div>
										<div class="class-name">${originalPeriod.className}</div>
									</div>
								` : ''}
								${subPeriodInfo ? `
									<div style="margin-top: 0.25rem;">
										<div class="subject substitute">${subPeriodInfo.subject}</div>
										<div class="class-name">(Sub for ${subPeriodInfo.teacher})</div>
										<div class="class-name">${subPeriodInfo.className}</div>
									</div>
								` : ''}
							</td>
						`;
					}).join('')}
				</tr>
			`;
		}).join('');

					detailsHtml = `
						<div class="mt-4">
							<div style="background: var(--primary-50); color: var(--primary-800);
										font-weight: 600; text-align: center; border-radius: var(--radius);
										padding: 0.75rem; margin-bottom: 1.5rem;">
								Total Weekly Periods: ${teacherDetails[selectedTeacher].periodCount}
							</div>
						</div>
						<div class="table-container">
							<table class="responsive sticky-first-col" role="table" aria-label="${selectedTeacher} weekly timetable">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>${tableBody}</tbody>
							</table>
						</div>
						<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
							<button onclick="handlePrint()" class="button button-secondary" style="max-width: 250px;">
								<i data-lucide="printer"></i> Print ${selectedTeacher} Schedule
							</button>
							<button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
								<i data-lucide="share-2"></i> Share
							</button>
							<button onclick="handleShareAsPDF()" class="button button-primary no-capture" style="max-width: 200px;">
								<i data-lucide="file-text"></i> Share as PDF
							</button>
							<button onclick="handleExportCSV()" class="button button-secondary no-capture" style="max-width: 200px;">
								<i data-lucide="download"></i> Export CSV
							</button>
						</div>
					`;
				}

				const html = `
					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
							👨‍🏫 View by Teacher
						</h2>
						<select onchange="renderTeacherView(this.value)">${teacherOptions}</select>
						<div id="teacher-details-container">${detailsHtml}</div>
					</div>
				`;

				mainContent.innerHTML = html;
				lucide.createIcons();

				if (selectedTeacher && teacherDetails[selectedTeacher]) {
					if (isMobile()) {
						renderTeacherViewMobile(selectedTeacher, getCurrentDay());
						setupFab('today');
						setupDaySwipeHandlers(() => switchDay(-1, 'Teacher'), () => switchDay(1, 'Teacher'));
					} else {
						setupFab('now');
					}
				}

			} catch (error) {
				console.error('Error rendering teacher view:', error);
				showToast('❌ Error loading teacher view');
			}
		}

		function renderTeacherViewMobile(selectedTeacher, day) {
			try {
				const { teacherDetails, periodHeaders } = state.allData;
				const container = document.getElementById('teacher-mobile-container');
				if (!container) return;
				document.querySelectorAll('.day-tab').forEach(btn => {
					btn.setAttribute('aria-selected', String(btn.dataset.day === day));
					btn.classList.toggle('active', btn.dataset.day === day);
				});
				const daySchedule = teacherDetails[selectedTeacher].schedule[day] || [];
				const today = getCurrentDay();
				const activeIdx = day === today ? getActivePeriodIndex() : -1;
				const list = periodHeaders.map((h, i) => {
					const p = daySchedule[i];
					return `
						<div class="timetable-row ${i===activeIdx?'is-current':''}" data-period-index="${i}" id="row-p${i}" role="button" tabindex="0" onclick="this.classList.toggle('expanded')" onkeypress="if(event.key==='Enter') this.click()">
							<div class="period-col">${h.name}<div style="font-weight:500; color: var(--gray-500); font-size: 0.75rem;">${h.time||''}</div></div>
							<div class="subject-col">${p ? p.subject : ''}</div>
							<div class="teacher-col">${selectedTeacher}</div>
							<div class="extra">${p ? ('Class: ' + p.className) : ''}</div>
						</div>`;
				}).join('');
				container.innerHTML = `<div class="timetable-list" aria-label="${selectedTeacher} - ${day}">${list}</div>`;
			} catch (e) { console.error(e); }
		}

		// --- OPTIMIZED PRINT FUNCTIONS ---
		function renderDayTimetableForPrint(selectedDay) {
			const { timetable, classNames, periodHeaders } = state.allData;
			const daySubs = state.substitutions[selectedDay]?.plan || {};
			
			let html = `
				<div style="page-break-inside: avoid;">
					<table style="width: 100%; font-size: 8pt; border-collapse: collapse;">
						<thead>
							<tr style="background: #f3f4f6;">
								<th style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold;">Class</th>
								${periodHeaders.map(h => 
									`<th style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold; text-align: center;">
										${h.name}<br><span style="font-size: 6pt;">${h.time}</span>
									</th>`
								).join('')}
							</tr>
						</thead>
						<tbody>
							${classNames.map(cName => {
								if (!timetable[selectedDay][cName]) return '';
								return `
									<tr>
										<td style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold; background: #f9fafb;">${cName}</td>
										${timetable[selectedDay][cName].map((period, i) => {
											const substitute = daySubs[cName]?.[i];
											return `
												<td style="border: 1px solid #d1d5db; padding: 4px 6px; text-align: center;">
													<div style="font-size: 7pt; font-weight: bold; margin-bottom: 1px;">${period.subject || ''}</div>
													${period.teacher ? `<div style="font-size: 6pt; ${substitute ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${period.teacher}</div>` : ''}
													${substitute ? `<div style="font-size: 6pt; color: #2563eb; font-weight: bold;">Sub: ${substitute}</div>` : ''}
												</td>
											`;
										}).join('')}
									</tr>
								`;
							}).filter(row => row).join('')}
						</tbody>
					</table>
				</div>
			`;
			return html;
		}

		function renderClassTimetableForPrint(selectedClass) {
			const { timetable, periodHeaders } = state.allData;
			
			let html = `
				<div style="page-break-inside: avoid;">
					<table style="width: 100%; font-size: 8pt; border-collapse: collapse;">
						<thead>
							<tr style="background: #f3f4f6;">
								<th style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold;">Day</th>
								${periodHeaders.map(h => 
									`<th style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold; text-align: center;">
										${h.name}<br><span style="font-size: 6pt;">${h.time}</span>
									</th>`
								).join('')}
							</tr>
						</thead>
						<tbody>
							${Object.keys(timetable).map(day => {
								const daySchedule = timetable[day][selectedClass] || [];
								return `
									<tr>
										<td style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold; background: #f9fafb;">${day}</td>
										${periodHeaders.map((_, i) => {
											const period = daySchedule[i];
											return `
												<td style="border: 1px solid #d1d5db; padding: 4px 6px; text-align: center;">
													${period ? `
														<div style="font-size: 7pt; font-weight: bold; margin-bottom: 1px;">${period.subject}</div>
														<div style="font-size: 6pt;">${period.teacher || ''}</div>
													` : ''}
												</td>
											`;
										}).join('')}
									</tr>
								`;
							}).join('')}
						</tbody>
					</table>
				</div>
			`;
			return html;
		}

		function renderTeacherTimetableForPrint(selectedTeacher) {
			const { teacherDetails, periodHeaders, timetable } = state.allData;
			const teacherData = teacherDetails[selectedTeacher];
			
			if (!teacherData) return '';
			
			let html = `
				<div style="page-break-inside: avoid;">
					<h3 style="text-align: center; margin: 0 0 1rem 0; font-size: 1.2em; color: #2563eb;">
						Weekly Schedule - ${selectedTeacher}
					</h3>
					<div style="text-align: center; margin-bottom: 1rem; font-size: 8pt; color: #6b7280;">
						Total Weekly Periods: ${teacherData.periodCount}
					</div>
					<table style="width: 100%; font-size: 8pt; border-collapse: collapse;">
						<thead>
							<tr style="background: #f3f4f6;">
								<th style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold;">Day</th>
								${periodHeaders.map(h => 
									`<th style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold; text-align: center;">${h.name}</th>`
								).join('')}
							</tr>
						</thead>
						<tbody>
							${Object.keys(timetable).map(day => {
								const daySchedule = teacherData.schedule[day] || [];
								return `
									<tr>
										<td style="border: 1px solid #d1d5db; padding: 4px 6px; font-weight: bold; background: #f9fafb;">${day}</td>
										${periodHeaders.map((_, i) => {
											const period = daySchedule[i];
											return `
												<td style="border: 1px solid #d1d5db; padding: 4px 6px; text-align: center;">
													${period ? `
														<div style="font-size: 7pt; font-weight: bold; margin-bottom: 1px;">${period.subject}</div>
														<div style="font-size: 6pt;">${period.className}</div>
													` : ''}
												</td>
											`;
										}).join('')}
									</tr>
								`;
							}).join('')}
						</tbody>
					</table>
				</div>
			`;
			return html;
		}

		function renderFullTimetableForPrint() {
			const { timetable, classNames, periodHeaders, days } = state.allData;
			let html = '';
			days.forEach((day, dayIndex) => {
				html += `
					<div style="${dayIndex > 0 ? 'page-break-before: always;' : ''} page-break-inside: avoid;">
						<h3 style="text-align: center; margin: 0 0 1rem 0; font-size: 1.1em; color: #2563eb;">${day}</h3>
						<table style="width: 100%; font-size: 7pt; border-collapse: collapse;">
							<thead>
								<tr style="background: #f3f4f6;">
									<th style="border: 1px solid #d1d5db; padding: 3px 4px; font-weight: bold;">Class</th>
									${periodHeaders.map(h => 
										`<th style="border: 1px solid #d1d5db; padding: 3px 4px; font-weight: bold; text-align: center;">
											${h.name}<br><span style="font-size: 5pt;">${h.time}</span>
										</th>`
									).join('')}
								</tr>
							</thead>
							<tbody>
								${classNames.map(cName => {
									if (!timetable[day][cName]) return '';
									return `
										<tr>
											<td style="border: 1px solid #d1d5db; padding: 3px 4px; font-weight: bold; background: #f9fafb;">${cName}</td>
											${timetable[day][cName].map(period => `
												<td style="border: 1px solid #d1d5db; padding: 3px 4px; text-align: center;">
													<div style="font-size: 6pt; font-weight: bold; margin-bottom: 1px;">${period.subject || ''}</div>
													${period.teacher ? `<div style="font-size: 5pt;">${period.teacher}</div>` : ''}
												</td>
											`).join('')}
										</tr>
									`;
								}).filter(row => row).join('')}
							</tbody>
						</table>
					</div>
				`;
			});
			return html;
		}

		function preparePrintContent() {
			try {
				let printContent = '';
				let title = '';
				
				// Set current date and time
				const now = new Date();
				document.getElementById('print-date').textContent = now.toLocaleDateString('en-GB');
				document.getElementById('print-time').textContent = now.toLocaleTimeString('en-US', { 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: true 
				});
				
				// Detect current view and prepare appropriate content
				switch(state.currentView) {
					case 'Day':
						// Find the active day button within the day view buttons (not main nav)
						const activeDayButton = document.querySelector('.nav-button[data-day].active');
						let targetDay = getCurrentDay();
						
						if (activeDayButton && activeDayButton.dataset.day) {
							targetDay = activeDayButton.dataset.day;
						} else {
							// Fallback: look for active day button by checking content
							const dayButtons = document.querySelectorAll('.nav-button[data-day]');
							dayButtons.forEach(btn => {
								if (btn.classList.contains('active')) {
									targetDay = btn.dataset.day;
								}
							});
						}
						
						printContent = renderDayTimetableForPrint(targetDay);
						title = `Daily Schedule - ${targetDay}`;
						break;
						
					case 'Class':
						const classSelect = document.querySelector('select')?.value;
						if (classSelect) {
							printContent = renderClassTimetableForPrint(classSelect);
							title = `Weekly Schedule - ${classSelect}`;
						} else {
							showToast('⚠️ Please select a class first', 3000, 'warning');
							return false;
						}
						break;
						
					case 'Teacher':
						const teacherSelect = document.querySelector('select')?.value;
						if (teacherSelect) {
							printContent = renderTeacherTimetableForPrint(teacherSelect);
							title = `Weekly Schedule - ${teacherSelect}`;
						} else {
							showToast('⚠️ Please select a teacher first', 3000, 'warning');
							return false;
						}
						break;
						
					case 'Dashboard':
					default:
						printContent = renderFullTimetableForPrint();
						title = "Complete School Timetable";
						break;
				}
				
				document.getElementById('print-header-subtitle').textContent = title;
				document.getElementById('print-content').innerHTML = printContent;
				return true;
			} catch (error) {
				console.error('Error preparing print content:', error);
				return false;
			}
		}

		// Pre-render print content and keep updated
		function updatePrintContent() {
			try {
				// Always keep the print content updated in background
				preparePrintContent();
			} catch (error) {
				console.error('Error updating print content:', error);
			}
		}

		// Wait for DOM rendering using requestAnimationFrame
		function waitForRender() {
			return new Promise(resolve => {
				requestAnimationFrame(() => {
					requestAnimationFrame(resolve);
				});
			});
		}

		// Ensure fonts are loaded before capturing
		async function ensureFontsLoaded() {
			try {
				if (document.fonts && document.fonts.ready) {
					await document.fonts.ready;
				}
				// Additional wait for font rendering
				await new Promise(resolve => setTimeout(resolve, 100));
			} catch (error) {
				console.warn('Font loading check failed:', error);
			}
		}

		// Helper function to get device pixel ratio with cap
		function getOptimalScale() {
			const devicePixelRatio = window.devicePixelRatio || 1;
			return Math.min(devicePixelRatio, 2); // Cap at 2 for performance
		}

		// Pure function: Convert table data to 2D array for CSV export
		function tableTo2DArray(tableElement) {
			if (!tableElement) return [];
			
			const rows = [];
			const headerRow = tableElement.querySelector('thead tr');
			const bodyRows = tableElement.querySelectorAll('tbody tr');
			
			// Extract headers
			if (headerRow) {
				const headers = Array.from(headerRow.querySelectorAll('th')).map(th => {
					return th.textContent.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
				});
				rows.push(headers);
			}
			
			// Extract body rows
			bodyRows.forEach(row => {
				const cells = Array.from(row.querySelectorAll('td')).map(td => {
					// Clean up cell content - remove line breaks and extra spaces
					return td.textContent.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
				});
				rows.push(cells);
			});
			
			return rows;
		}

		async function handlePrint() {
			try {
				// Check if mobile and offer alternative
				const isMobile = window.innerWidth <= 768;
				
				if (isMobile) {
					const userChoice = confirm(
						"📱 Mobile Print Options:\n\n" +
						"✅ OK = Print (may need landscape orientation)\n" +
						"❌ Cancel = Share as image instead\n\n" +
						"Tip: For best mobile printing, rotate to landscape!"
					);
					
					if (!userChoice) {
						handleShareScreenshot();
						return;
					}
					
					// Show mobile print tip
					showToast("💡 Tip: Rotate to landscape for better mobile printing!", 4000, 'info');
				}
				
				if (preparePrintContent()) {
					const captureElement = document.getElementById('print-capture-area');
					const previousDisplay = captureElement.style.display;
					// Show the print area temporarily
					captureElement.style.display = 'block';
					// Wait for DOM to render
					await waitForRender();
					window.print();
					// Hide the print area again after printing
					captureElement.style.display = previousDisplay || 'none';
					showToast(isMobile ? "📱 Mobile print dialog opened" : "📄 Print dialog opened", 2000, 'info');
				} else {
					showToast("⚠️ No printable content available.", 3000, 'warning');
				}
			} catch (error) {
				console.error('Print error:', error);
				showToast("❌ Print failed. Try sharing as image instead.", 3000, 'error');
			}
		}

		// --- FIX SUBSTITUTION VIEW ---
		function renderSubstitutionView(day = null, absentTeachers = []) {
			const { teacherNames, periodHeaders, teacherDetails, timetable, days } = state.allData;
			// Always default to the current day when none is provided
			const currentDay = getCurrentDay();
			const selectedDay = day || currentDay;
			document.getElementById('print-header-subtitle').textContent = `Substitution Plan for ${selectedDay}`;


			const teacherOptionsHtml = teacherNames.map(t => `
				<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
							  border-radius: var(--radius); cursor: pointer; transition: background 0.2s;">
					<input type="checkbox" value="${t}" ${absentTeachers.includes(t) ? 'checked' : ''}
						   onchange="handleAbsentTeacherChange(this)">
					<span>${t}</span>
				</label>
			`).join('');

			const daySubsData = state.substitutions[selectedDay]?.plan || {};
			const vacantSlots = [];
			absentTeachers.forEach(absentTeacher => {
				const schedule = teacherDetails[absentTeacher]?.schedule[selectedDay];
				if (schedule) {
					schedule.forEach((period, periodIndex) => {
						if (period) {
							vacantSlots.push({ ...period, periodIndex, originalTeacher: absentTeacher });
						}
					});
				}
			});

			const plan = vacantSlots.map(slot => {
				const substitute = daySubsData[slot.className]?.[slot.periodIndex];
				return { ...slot, substitute };
			}).sort((a, b) => a.periodIndex - b.periodIndex);


	let planTableHTML = '';
	if (plan.length > 0) {
		const tableRows = plan.map(slot => `
			<tr>
				<td>${periodHeaders[slot.periodIndex].name}</td>
				<td>${slot.className}</td>
				<td>${slot.subject}</td>
				<td style="color: var(--red-600);">${slot.originalTeacher}</td>
				<td><span class="substitute">${slot.substitute || '--'}</span></td>
			</tr>
		`).join('');

		planTableHTML = `
			<div style="margin-top: 2rem;">
				<div id="substitution-plan-content">
					<h3 style="text-align: center; margin-bottom: 1rem; font-size: 1.25rem;">
						📋 Substitution Plan: ${selectedDay}
					</h3>
					<div class="table-container">
						<table>
							<thead>
								<tr>
									<th>Period</th>
									<th>Class</th>
									<th>Subject</th>
									<th>Original Teacher</th>
									<th>Substitute</th>
								</tr>
							</thead>
							<tbody>${tableRows}</tbody>
						</table>
					</div>
					<div class="flex justify-center gap-4" style="margin-top: 1.5rem; flex-wrap: wrap;">
						<button onclick="handleShareSubstitutionPlan('${selectedDay}')" class="button button-whatsapp" style="max-width: 250px;">
							<i data-lucide="share-2"></i> Share Substitution Plan (Image)
						</button>
						<button onclick="handleShareSubstitutionPlanText('${selectedDay}')" class="button button-secondary" style="max-width: 250px;">
							<i data-lucide="clipboard"></i> Copy Text Plan
						</button>
						<button onclick="handlePrintSubstitutionPlan('${selectedDay}')" class="button button-secondary" style="max-width: 250px;">
							<i data-lucide="printer"></i> Print Plan
						</button>
					</div>
				</div>
			</div>
		`;
	}

			const html = `
				<div class="card">
					<div class="grid grid-cols-1 gap-6">
						<div>
							<label class="block font-bold mb-2">Select Absent Teachers (for ${selectedDay})</label>
							<div style="border: 1px solid var(--gray-300); border-radius: var(--radius);
									padding: 0.5rem; max-height: 15rem; overflow-y: auto;">
								${teacherOptionsHtml}
							</div>
						</div>
					</div>
					<div class="grid grid-cols-1 grid-cols-md-2 gap-4"
						 style="border-top: 1px solid var(--gray-200); padding-top: 1.5rem; margin-top: 1.5rem;">
						<button id="generate-plan-btn" class="button button-primary">
							<i data-lucide="wand-2"></i> Generate Smart Plan
						</button>
						<button id="reset-plan-btn" class="button button-danger">
							<i data-lucide="rotate-ccw"></i> Reset ${selectedDay} Plan
						</button>
					</div>
					<div id="plan-container">${planTableHTML}</div>
					<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
						<button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
							<i data-lucide="printer"></i> Print Full Timetable
						</button>
					</div>
				</div>
			`;

			mainContent.innerHTML = html;
			attachSubstitutionEventListeners(selectedDay, absentTeachers);
			lucide.createIcons();
		}

		// --- EVENT HANDLERS & LOGIC ---
		function attachSubstitutionEventListeners(day, absentTeachers) {
			try {
				const generateBtn = document.getElementById('generate-plan-btn');
				const resetBtn = document.getElementById('reset-plan-btn');
				
				if (generateBtn) {
					generateBtn.addEventListener('click', () => {
						try {
							handleGeneratePlan(day, absentTeachers);
						} catch (error) {
							console.error('Error in generate plan button:', error);
							showToast('❌ Error generating plan', 3000, 'error');
						}
					});
				}
				
				if (resetBtn) {
					resetBtn.addEventListener('click', () => {
						try {
							handleResetPlan(day);
						} catch (error) {
							console.error('Error in reset plan button:', error);
							showToast('❌ Error resetting plan', 3000, 'error');
						}
					});
				}
			} catch (error) {
				console.error('Error attaching substitution event listeners:', error);
			}
		}
		function handleAbsentTeacherChange(checkbox) {
			try {
				const day = getCurrentDay();
				const selectedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
				const absentTeachers = selectedCheckboxes.map(cb => cb.value);
				renderSubstitutionView(day, absentTeachers);
			} catch (error) {
				console.error('Error handling absent teacher change:', error);
				showToast('❌ Error updating teacher selection', 3000, 'error');
			}
		}

		// --- VIEW SWITCHING ---
		function switchView(view) {
			// Clear intervals
			if (window.dashboardInterval) {
				clearInterval(window.dashboardInterval);
				window.dashboardInterval = null;
			}

			state.currentView = view;
			
			// Update navigation
			document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
			const activeBtn = document.getElementById(`nav-${view}`);
			if (activeBtn) activeBtn.classList.add('active');

			// Render view
			switch(view) {
				case 'Dashboard':
					renderDashboard();
					break;
				case 'Day':
					renderDayView();
					break;
				case 'Substitution':
					renderSubstitutionView();
					break;
				case 'Class':
					renderClassView();
					break;
				case 'Teacher':
					renderTeacherView();
					break;
				default:
					renderDashboard();
			}

			// Update print content when view changes
			setTimeout(() => updatePrintContent(), 100);
		}

		// --- SUBSTITUTION MANAGEMENT ---
		function handleGeneratePlan(day, absentTeachers) {
			try {
				if (!day || !absentTeachers || absentTeachers.length === 0) {
					showToast('⚠️ Please select at least one absent teacher', 3000, 'warning');
					return;
				}

				const { teacherDetails, timetable } = state.allData;
				const vacantSlots = [];

				// Find all slots that need substitution
				absentTeachers.forEach(teacher => {
					const schedule = teacherDetails[teacher]?.schedule[day];
					if (schedule) {
						schedule.forEach((period, periodIndex) => {
							if (period) {
								vacantSlots.push({
									...period,
									periodIndex,
									originalTeacher: teacher
								});
							}
						});
					}
				});

				// Initialize substitution structure if needed
				if (!state.substitutions[day]) {
					state.substitutions[day] = { plan: {}, absentTeachers: [] };
				}
				state.substitutions[day].absentTeachers = [...absentTeachers];
				
				// Clear existing plan for these slots
				vacantSlots.forEach(slot => {
					if (!state.substitutions[day].plan[slot.className]) {
						state.substitutions[day].plan[slot.className] = {};
					}
					delete state.substitutions[day].plan[slot.className][slot.periodIndex];
				});

				// Generate new plan with enhanced algorithm
				const newPlan = state.substitutions[day].plan;
				vacantSlots.forEach(slot => {
					const freeTeachers = findFreeTeachers(
						day, 
						slot.periodIndex, 
						absentTeachers, 
						newPlan,
						slot // Pass the vacant period details for better matching
					);
					
					if (freeTeachers.length > 0) {
						if (!newPlan[slot.className]) {
							newPlan[slot.className] = {};
						}
						// Use the highest-scored teacher (first in sorted array)
						newPlan[slot.className][slot.periodIndex] = freeTeachers[0].teacher;
						
						// Log the recommendation for debugging
						console.log(`Assigned ${freeTeachers[0].teacher} to ${slot.className} Period ${slot.periodIndex + 1} (Score: ${freeTeachers[0].score}, Reason: ${freeTeachers[0].reason})`);
					}
				});

				// Save updated plan
				state.substitutions[day].plan = newPlan;
				showToast('✅ Substitution plan generated successfully!', 3000, 'success');
				renderSubstitutionView(day, absentTeachers);
				
			} catch (error) {
				console.error('Error generating substitution plan:', error);
				showToast('❌ Failed to generate substitution plan', 3000, 'error');
			}
		}

		function handleResetPlan(day) {
			try {
				if (!day) {
					showToast('⚠️ No day selected', 3000, 'warning');
					return;
				}

				if (!state.substitutions[day] || !state.substitutions[day].plan) {
					showToast('ℹ️ No substitution plan exists for this day', 3000, 'info');
					return;
				}

				const confirmReset = confirm(`Are you sure you want to reset the substitution plan for ${day}?`);
				if (!confirmReset) return;

				const absentTeachers = state.substitutions[day].absentTeachers || [];
				state.substitutions[day] = { plan: {}, absentTeachers };
				
				showToast('✅ Substitution plan reset successfully', 3000, 'success');
				renderSubstitutionView(day, absentTeachers);
				
			} catch (error) {
				console.error('Error resetting substitution plan:', error);
				showToast('❌ Failed to reset substitution plan', 3000, 'error');
			}
		}

		async function handleShareScreenshot() {
			try {
				const captureElement = document.getElementById('print-capture-area');
				
				if (!captureElement) {
					showToast('❌ Required elements not found', 3000, 'error');
					return;
				}

				// Check if html2canvas is available
				if (typeof html2canvas === 'undefined') {
					showToast('❌ Screenshot library not loaded', 3000, 'error');
					return;
				}
				
				// 1. Populate print content using existing preparePrintContent()
				if (!preparePrintContent()) {
					showToast('❌ Failed to prepare print content', 3000, 'error');
					return;
				}
				
				// 2. Store original display state and temporarily show print area
				const originalDisplay = captureElement.style.display;
				captureElement.style.display = 'block';
				
				try {
					// 3. Ensure fonts are loaded and wait for rendering
					await ensureFontsLoaded();
					await waitForRender();
					
					// 4. Capture with optimal settings using device pixel ratio
					const canvas = await html2canvas(captureElement, {
						backgroundColor: '#fff',
						scale: getOptimalScale(),
						useCORS: true,
						allowTaint: false,
						foreignObjectRendering: false,
						imageTimeout: 15000,
						removeContainer: false
					});
					
					// 5. Convert canvas to blob and handle sharing/download
					canvas.toBlob(async (blob) => {
						try {
							if (!blob) {
								throw new Error('Failed to create image blob');
							}

							const file = new File([blob], 'timetable.png', { type: 'image/png' });
							
							// Try Web Share API first (mobile-friendly)
							if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
								try {
									await navigator.share({
										files: [file],
										title: 'Veer Patta Public School Timetable',
										text: 'Check out our school timetable!'
									});
									showToast('✅ Timetable shared successfully', 3000, 'success');
								} catch (shareError) {
									if (shareError.name !== 'AbortError') {
										console.warn('Share failed, falling back to download:', shareError);
										downloadImage(blob, 'timetable.png');
										showToast('⚠️ Sharing failed. Image downloaded instead.', 3000, 'warning');
									}
								}
							} else {
								// Fallback to download if sharing not supported
								downloadImage(blob, 'timetable.png');
								showToast('✅ Timetable image downloaded', 3000, 'success');
							}
						} catch (error) {
							console.error('Error processing image blob:', error);
							showToast('❌ Failed to process image', 3000, 'error');
						}
					}, 'image/png', 0.95);
					
				} finally {
					// 6. Always restore original DOM state (no flicker)
					captureElement.style.display = originalDisplay;
				}
				
			} catch (error) {
				console.error('Screenshot capture error:', error);
				showToast('❌ Failed to capture screenshot', 3000, 'error');
				
				// Ensure cleanup even on error
				const captureElement = document.getElementById('print-capture-area');
				if (captureElement) {
					captureElement.style.display = 'none';
				}
			}
		}

		// New function: Share as PDF
		async function handleShareAsPDF() {
			try {
				// Check if jsPDF is available
				if (typeof window.jsPDF === 'undefined') {
					showToast('❌ PDF library not loaded', 3000, 'error');
					return;
				}

				const captureElement = document.getElementById('print-capture-area');
				if (!captureElement) {
					showToast('❌ Required elements not found', 3000, 'error');
					return;
				}

				// Prepare print content
				if (!preparePrintContent()) {
					showToast('❌ Failed to prepare print content', 3000, 'error');
					return;
				}

				showToast('📄 Generating PDF...', 2000, 'info');

				const originalDisplay = captureElement.style.display;
				captureElement.style.display = 'block';

				try {
					await ensureFontsLoaded();
					await waitForRender();

					// Capture with html2canvas
					const canvas = await html2canvas(captureElement, {
						backgroundColor: '#fff',
						scale: getOptimalScale(),
						useCORS: true,
						allowTaint: false,
						foreignObjectRendering: false,
						imageTimeout: 15000
					});

					// Create PDF
					const { jsPDF } = window.jsPDF;
					const pdf = new jsPDF({
						orientation: 'landscape',
						unit: 'mm',
						format: 'a4'
					});

					// Calculate dimensions
					const pdfWidth = pdf.internal.pageSize.getWidth();
					const pdfHeight = pdf.internal.pageSize.getHeight();
					const canvasWidth = canvas.width;
					const canvasHeight = canvas.height;
					const ratio = Math.min(pdfWidth / canvasWidth, pdfHeight / canvasHeight);
					const imgWidth = canvasWidth * ratio;
					const imgHeight = canvasHeight * ratio;
					const x = (pdfWidth - imgWidth) / 2;
					const y = (pdfHeight - imgHeight) / 2;

					// Add image to PDF
					const imgData = canvas.toDataURL('image/png');
					pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);

					// Generate filename
					const now = new Date();
					const dateStr = now.toISOString().split('T')[0];
					const filename = `vpps-timetable-${dateStr}.pdf`;

					// Save PDF
					pdf.save(filename);
					showToast('✅ PDF saved successfully!', 3000, 'success');

				} finally {
					captureElement.style.display = originalDisplay;
				}

			} catch (error) {
				console.error('PDF generation error:', error);
				showToast('❌ Failed to generate PDF', 3000, 'error');
			}
		}

		// New function: Export CSV
		function handleExportCSV() {
			try {
				// Find the current visible table
				const visibleTable = document.querySelector('.table-container table:not(#print-capture-area table)');
				if (!visibleTable) {
					showToast('❌ No table found to export', 3000, 'error');
					return;
				}

				// Convert table to 2D array
				const data = tableTo2DArray(visibleTable);
				if (data.length === 0) {
					showToast('❌ No data found in table', 3000, 'error');
					return;
				}

				// Convert to CSV format
				const csvContent = data.map(row => 
					row.map(cell => `"${cell.replace(/"/g, '""')}"`)
						.join(',')
				).join('\n');

				// Create and download CSV file
				const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
				const now = new Date();
				const dateStr = now.toISOString().split('T')[0];
				const filename = `vpps-timetable-${dateStr}.csv`;

				const link = document.createElement('a');
				const url = URL.createObjectURL(blob);
				link.setAttribute('href', url);
				link.setAttribute('download', filename);
				link.style.visibility = 'hidden';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				URL.revokeObjectURL(url);

				showToast('✅ CSV exported successfully!', 3000, 'success');

			} catch (error) {
				console.error('CSV export error:', error);
				showToast('❌ Failed to export CSV', 3000, 'error');
			}
		}

		function downloadImage(blob, filename) {
			try {
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			} catch (error) {
				console.error('Error downloading image:', error);
				showToast('❌ Failed to download image', 3000, 'error');
			}
		}

		function handleShareSubstitutionPlan(day) {
			try {
				const planContent = document.getElementById('substitution-plan-content');
				if (!planContent) {
					showToast('⚠️ No substitution plan to share', 3000, 'warning');
					return;
				}

				// Create a temporary container for the substitution plan only
				const tempContainer = document.createElement('div');
				tempContainer.style.cssText = `
					background: white;
					padding: 2rem;
					font-family: 'Inter', sans-serif;
					position: absolute;
					left: -9999px;
					top: -9999px;
					width: 800px;
				`;
				
				// Add school header
				tempContainer.innerHTML = `
					<div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #2563eb; padding-bottom: 1rem;">
						<h1 style="color: #2563eb; font-size: 1.5rem; margin: 0;">Veer Patta Public School</h1>
						<p style="color: #6b7280; margin: 0.5rem 0 0 0;">Substitution Plan - ${day}</p>
						<small style="color: #9ca3af;">Generated on ${new Date().toLocaleDateString('en-GB')} at ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</small>
					</div>
					${planContent.innerHTML}
				`;
				
				document.body.appendChild(tempContainer);
				
				html2canvas(tempContainer, {
					backgroundColor: '#ffffff',
					width: 800,
					height: tempContainer.scrollHeight,
					scale: 2
				}).then(canvas => {
					document.body.removeChild(tempContainer);
					
					canvas.toBlob(blob => {
						try {
							const fileName = `substitution-plan-${day.toLowerCase()}-${new Date().toISOString().split('T')[0]}.png`;
							const file = new File([blob], fileName, { type: 'image/png' });
							
							// Generate WhatsApp sharing text
							const whatsappText = `📋 *Substitution Plan - ${day}*\n\n` +
								`🏫 *Veer Patta Public School*\n` +
								`📅 Date: ${new Date().toLocaleDateString('en-GB')}\n` +
								`⏰ Generated: ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}\n\n` +
								`Please see the attached image for detailed substitution assignments.`;
							
							// Check if Web Share API is available
							if (navigator.share) {
								navigator.share({
									files: [file],
									title: `Substitution Plan - ${day}`,
									text: whatsappText
								}).then(() => {
									showToast('✅ Substitution plan shared successfully!', 3000, 'success');
								}).catch(err => {
									console.error('Share failed:', err);
									// Fallback to download
									downloadSubstitutionPlan(blob, fileName, whatsappText);
								});
							} else {
								// Fallback for browsers without Web Share API
								downloadSubstitutionPlan(blob, fileName, whatsappText);
							}
						} catch (error) {
							console.error('Error sharing substitution plan:', error);
							showToast('❌ Failed to share substitution plan', 3000, 'error');
						}
					});
				}).catch(error => {
					document.body.removeChild(tempContainer);
					console.error('Error capturing substitution plan:', error);
					showToast('❌ Failed to capture substitution plan', 3000, 'error');
				});
				
			} catch (error) {
				console.error('Error in handleShareSubstitutionPlan:', error);
				showToast('❌ Failed to share substitution plan', 3000, 'error');
			}
		}

		function downloadSubstitutionPlan(blob, fileName, whatsappText) {
			// Download the image
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = fileName;
			a.click();
			URL.revokeObjectURL(url);
			
			// Copy WhatsApp text to clipboard
			navigator.clipboard.writeText(whatsappText).then(() => {
				showToast('✅ Plan downloaded & text copied to clipboard!', 4000, 'success');
			}).catch(() => {
				showToast('✅ Substitution plan downloaded successfully!', 3000, 'success');
			});
		}

		// --- TEXT-BASED SHARING FOR SUBSTITUTION PLAN ---
		function handleShareSubstitutionPlanText(day) {
			try {
				const { periodHeaders } = state.allData;
				const daySubsData = state.substitutions[day]?.plan || {};
				
				// Gather all slots for the day
				let slots = [];
				for (const className in daySubsData) {
					for (const periodIdx in daySubsData[className]) {
						slots.push({
							className,
							periodIndex: parseInt(periodIdx, 10),
							substitute: daySubsData[className][periodIdx]
						});
					}
				}
				
				if (slots.length === 0) {
					showToast('⚠️ No substitution plan to share', 3000, 'warning');
					return;
				}
				
				// Sort by period, then class
				slots.sort((a, b) => a.periodIndex - b.periodIndex || a.className.localeCompare(b.className));
				
				// Build text summary
				let text = `📋 Substitution Plan - ${day}\n`;
				text += `🏫 Veer Patta Public School\n`;
				text += `📅 Date: ${new Date().toLocaleDateString('en-GB')}\n`;
				text += `⏰ Generated: ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}\n\n`;
				text += `Period | Class | Substitute\n`;
				text += `-----------------------------\n`;
				
				slots.forEach(slot => {
					const periodName = periodHeaders[slot.periodIndex]?.name || `P${slot.periodIndex+1}`;
					text += `${periodName} | ${slot.className} | ${slot.substitute || '--'}\n`;
				});
				
				// Copy to clipboard
				navigator.clipboard.writeText(text).then(() => {
					showToast('✅ Text plan copied to clipboard!', 3000, 'success');
				}).catch(() => {
					showToast('⚠️ Failed to copy text plan', 3000, 'warning');
				});
				
			} catch (error) {
				console.error('Error sharing text substitution plan:', error);
				showToast('❌ Failed to share text plan', 3000, 'error');
			}
		}

		async function handlePrintSubstitutionPlan(day) {
			try {
				const planContent = document.getElementById('substitution-plan-content');
				if (!planContent) {
					showToast('⚠️ No substitution plan to print', 3000, 'warning');
					return;
				}

				// Prepare print content
				const captureElement = document.getElementById('print-capture-area');
				const prevContent = document.getElementById('print-content').innerHTML;
				const prevSubtitle = document.getElementById('print-header-subtitle').textContent;

				document.getElementById('print-header-subtitle').textContent = `Substitution Plan - ${day}`;
				document.getElementById('print-content').innerHTML = planContent.innerHTML;

				const prevDisplay = captureElement.style.display;
				captureElement.style.display = 'block';
				// Wait for DOM to render
				await waitForRender();
				window.print();
				// Restore previous content
				captureElement.style.display = prevDisplay;
				document.getElementById('print-content').innerHTML = prevContent;
				document.getElementById('print-header-subtitle').textContent = prevSubtitle;
			} catch (error) {
				console.error('Error printing substitution plan:', error);
				showToast('❌ Failed to print substitution plan', 3000, 'error');
			}
		}

		// --- INITIALIZATION FUNCTION ---
		async function init() {
			try {
				// Validate required DOM elements exist
				const requiredElements = ['main-content', 'print-capture-area', 'print-header-title', 'print-header-subtitle', 'print-content'];
				const missingElements = requiredElements.filter(id => !document.getElementById(id));
				
				if (missingElements.length > 0) {
					throw new Error(`Missing required DOM elements: ${missingElements.join(', ')}`);
				}

				// Parse data
				state.allData = parseTimetableData();
				console.log('Initialized with data:', state.allData.days);
				
				// Validate parsed data
				if (!state.allData || !state.allData.days || state.allData.days.length === 0) {
					throw new Error('Failed to parse timetable data properly');
				}
				
				// Initialize substitutions structure
				state.allData.days.forEach(day => {
					if (!state.substitutions[day]) {
						state.substitutions[day] = { plan: {}, absentTeachers: [] };
					}
				});
				
				// Render initial view
				switchView('Dashboard');
				
				// Set up toast style
				const style = document.createElement('style');
				style.innerHTML = `
				.toast-notification {
					position: fixed;
					top: 1rem;
					left: 1rem;
					right: 1rem;
					z-index: 10000;
					background: var(--primary-600);
					color: white;
					padding: 1rem;
					border-radius: var(--radius-lg);
					box-shadow: var(--shadow-xl);
					transition: all 0.3s ease;
					font-size: 0.9rem;
					font-weight: 600;
					text-align: center;
					opacity: 1;
					backdrop-filter: blur(8px);
				}
				
				@media (min-width: 768px) {
					.toast-notification {
						top: 20px;
						right: 20px;
						left: auto;
						max-width: 350px;
						font-size: 0.875rem;
						font-weight: 500;
						text-align: left;
					}
				}
				.toast-notification.error {
					background: var(--red-500);
				}
				.toast-notification.success {
					background: var(--green-500);
				}
				.toast-notification.warning {
					background: var(--yellow-500);
				}
				@keyframes pulse {
					0%, 100% { opacity: 1; }
					50% { opacity: .5; }
				}
			`;
			document.head.appendChild(style);
			
			// Hide loader after a delay for smoother UX
			setTimeout(() => {
				const loader = document.getElementById('loader');
				loader.style.opacity = '0';
				setTimeout(() => {
					loader.style.display = 'none';
				}, 300);

				// Add keyboard shortcuts with error handling
				document.addEventListener('keydown', (e) => {
					try {
						if (e.altKey) {
							switch(e.key) {
								case '1': switchView('Dashboard'); break;
								case '2': switchView('Day'); break;
								case '3': switchView('Substitution'); break;
								case '4': switchView('Class'); break;
								case '5': switchView('Teacher'); break;
							}
						}
					} catch (error) {
						console.error('Error in keyboard shortcut:', error);
					}
				});

				// Add mobile-specific touch gestures for navigation
				let touchStartX = 0;
				let touchEndX = 0;
				const minSwipeDistance = 100;
				const views = ['Dashboard', 'Day', 'Substitution', 'Class', 'Teacher'];
				
				document.addEventListener('touchstart', (e) => {
					touchStartX = e.changedTouches[0].screenX;
				}, { passive: true });

				document.addEventListener('touchend', (e) => {
					touchEndX = e.changedTouches[0].screenX;
					handleSwipe();
				}, { passive: true });

				function handleSwipe() {
					const swipeDistance = touchEndX - touchStartX;
					const currentIndex = views.indexOf(state.currentView);
					
					if (Math.abs(swipeDistance) > minSwipeDistance) {
						if (swipeDistance > 0 && currentIndex > 0) {
							// Swipe right - go to previous view
							switchView(views[currentIndex - 1]);
							showToast(`👈 Switched to ${views[currentIndex - 1]}`, 1500, 'info');
						} else if (swipeDistance < 0 && currentIndex < views.length - 1) {
							// Swipe left - go to next view
							switchView(views[currentIndex + 1]);
							showToast(`👉 Switched to ${views[currentIndex + 1]}`, 1500, 'info');
						}
					}
				}

				// Add pull-to-refresh functionality for mobile
				let pullStartY = 0;
				let pullDistance = 0;
				const pullThreshold = 80;
				
				document.addEventListener('touchstart', (e) => {
					if (window.scrollY === 0) {
						pullStartY = e.touches[0].clientY;
					}
				}, { passive: true });
				
				document.addEventListener('touchmove', (e) => {
					if (window.scrollY === 0 && pullStartY > 0) {
						pullDistance = e.touches[0].clientY - pullStartY;
						if (pullDistance > 0 && pullDistance < pullThreshold * 2) {
							// Visual feedback for pull-to-refresh could be added here
						}
					}
				}, { passive: true });
				
				document.addEventListener('touchend', () => {
					if (pullDistance > pullThreshold) {
						// Refresh current view
						switch(state.currentView) {
							case 'Dashboard':
								renderDashboard();
								showToast('🔄 Dashboard refreshed!', 2000, 'success');
								break;
							case 'Day':
								renderDayView();
								showToast('🔄 Day view refreshed!', 2000, 'success');
								break;
							default:
								showToast('🔄 View refreshed!', 2000, 'success');
						}
					}
					pullStartY = 0;
					pullDistance = 0;
				}, { passive: true });

				// Handle orientation changes for mobile
				window.addEventListener('orientationchange', () => {
					setTimeout(() => {
						// Re-render current view after orientation change
						switch(state.currentView) {
							case 'Dashboard':
								renderDashboard();
								break;
							case 'Day':
								renderDayView();
								break;
							case 'Substitution':
								renderSubstitutionView();
								break;
							case 'Class':
								renderClassView();
								break;
							case 'Teacher':
								renderTeacherView();
								break;
						}
						showToast('📱 Layout optimized for new orientation', 2000, 'info');
					}, 100);
				});

				// Register service worker for offline functionality
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('./sw.js')
						.then(registration => {
							console.log('Service Worker registered successfully:', registration.scope);
						})
						.catch(error => {
							console.log('Service Worker registration failed:', error);
						});
				}

				// Pre-render print content on load
				updatePrintContent();

				showToast('📱 Mobile-optimized Timetable Command Center loaded!', 2500, 'success');
			}, 300);
			
			} catch (error) {
				console.error('Initialization error:', error);
				
				// Try to safely show error toast
				try {
					showToast('❌ Failed to load timetable data', 5000, 'error');
				} catch (toastError) {
					console.error('Failed to show error toast:', toastError);
				}
				
				// Show fallback content
				const mainContentElement = document.getElementById('main-content');
				if (mainContentElement) {
					mainContentElement.innerHTML = `
					<div class="card">
						<div style="color: var(--red-500); padding: 2rem; text-align: center;">
							<i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><br>
							<h3>Initialization Error</h3>
							<p>Failed to load the timetable application. Please refresh the page.</p>
							<p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 1rem;">
								Error details: ${error.message}
							</p>
							<button onclick="window.location.reload()" class="button button-primary" style="margin-top: 1rem; max-width: 200px;">
								Reload Page
							</button>
						</div>
					</div>
					`;
					
					// Safely create icons
					try {
						if (typeof lucide !== 'undefined' && lucide.createIcons) {
							lucide.createIcons();
						}
					} catch (iconError) {
						console.error('Failed to create icons:', iconError);
					}
				}
			}
		}

		// Initialize app when window loads with mobile-optimized fallback
		if (typeof window !== 'undefined') {
			// Add mobile-specific event listeners
			document.addEventListener('DOMContentLoaded', () => {
				// Prevent zoom on double tap
				let lastTouchEnd = 0;
				document.addEventListener('touchend', (event) => {
					const now = (new Date()).getTime();
					if (now - lastTouchEnd <= 300) {
						event.preventDefault();
					}
					lastTouchEnd = now;
				}, false);
				
				// Prevent context menu on long press for cleaner mobile experience
				document.addEventListener('contextmenu', (e) => {
					if (e.target.tagName === 'TD' || e.target.tagName === 'TH') {
						e.preventDefault();
					}
				});
			});
			
			if (document.readyState === 'loading') {
				window.addEventListener('load', init);
			} else {
				// If document is already loaded, run init immediately
				init();
			}
		} else {
			console.error('Window object not available');
		}
	</script>
</body>
</html>
